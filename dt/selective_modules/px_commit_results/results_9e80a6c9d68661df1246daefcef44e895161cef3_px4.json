{"sha":"9e80a6c9d68661df1246daefcef44e895161cef3","node_id":"MDY6Q29tbWl0NTI5ODc5MDo5ZTgwYTZjOWQ2ODY2MWRmMTI0NmRhZWZjZWY0NGU4OTUxNjFjZWYz","commit":{"author":{"name":"Matthias Grob","email":"maetugr@gmail.com","date":"2017-01-30T15:47:56Z"},"committer":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2017-02-02T20:24:05Z"},"message":"sensors: rc filter no unstable cutoff, better initialisation, reset filter on change, constrain output\nFilter gets unstable if cutoff is above sample rate/2.\nFilter initial frequencies do not matter a lot because they get replaced by parameters anyways.\nFilter delay values get reset to 0 when the filter is reconfigured otherwise there can be some weird spikes in the output.\nFilter output gets constrained to the range again because of possible overshoot.","tree":{"sha":"6d237cb4c9eee5353599303ab91867070c2bc818","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/6d237cb4c9eee5353599303ab91867070c2bc818"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/9e80a6c9d68661df1246daefcef44e895161cef3","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/9e80a6c9d68661df1246daefcef44e895161cef3","html_url":"https://github.com/PX4/PX4-Autopilot/commit/9e80a6c9d68661df1246daefcef44e895161cef3","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/9e80a6c9d68661df1246daefcef44e895161cef3/comments","author":{"login":"MaEtUgR","id":4668506,"node_id":"MDQ6VXNlcjQ2Njg1MDY=","avatar_url":"https://avatars.githubusercontent.com/u/4668506?v=4","gravatar_id":"","url":"https://api.github.com/users/MaEtUgR","html_url":"https://github.com/MaEtUgR","followers_url":"https://api.github.com/users/MaEtUgR/followers","following_url":"https://api.github.com/users/MaEtUgR/following{/other_user}","gists_url":"https://api.github.com/users/MaEtUgR/gists{/gist_id}","starred_url":"https://api.github.com/users/MaEtUgR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MaEtUgR/subscriptions","organizations_url":"https://api.github.com/users/MaEtUgR/orgs","repos_url":"https://api.github.com/users/MaEtUgR/repos","events_url":"https://api.github.com/users/MaEtUgR/events{/privacy}","received_events_url":"https://api.github.com/users/MaEtUgR/received_events","type":"User","site_admin":false},"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"81dcba3a2a2c79d404d50c63af1cd9fbf6c26258","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/81dcba3a2a2c79d404d50c63af1cd9fbf6c26258","html_url":"https://github.com/PX4/PX4-Autopilot/commit/81dcba3a2a2c79d404d50c63af1cd9fbf6c26258"}],"stats":{"total":38,"additions":24,"deletions":14},"files":[{"sha":"8427d83a985688d934fb52854abee992835e0342","filename":"src/modules/sensors/parameters.cpp","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/9e80a6c9d68661df1246daefcef44e895161cef3/src%2Fmodules%2Fsensors%2Fparameters.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/9e80a6c9d68661df1246daefcef44e895161cef3/src%2Fmodules%2Fsensors%2Fparameters.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fsensors%2Fparameters.cpp?ref=9e80a6c9d68661df1246daefcef44e895161cef3","patch":"@@ -388,7 +388,8 @@ int update_parameters(const ParameterHandles &parameter_handles, Parameters &par\n \tparam_get(parameter_handles.rc_flt_smp_rate, &(parameters.rc_flt_smp_rate));\n \tparameters.rc_flt_smp_rate = math::max(1.0f, parameters.rc_flt_smp_rate);\n \tparam_get(parameter_handles.rc_flt_cutoff, &(parameters.rc_flt_cutoff));\n-\tparameters.rc_flt_cutoff = math::max(1.0f, parameters.rc_flt_cutoff);\n+\t/* make sure the filter is in its stable region -> fc < fs/2 */\n+\tparameters.rc_flt_cutoff = math::constrain(parameters.rc_flt_cutoff, 0.1f, (parameters.rc_flt_smp_rate / 2) - 1.f);\n \n \t/* Airspeed offset */\n \tparam_get(parameter_handles.diff_pres_offset_pa, &(parameters.diff_pres_offset_pa));"},{"sha":"7c649b03114837f6ae2b114b7aa7663d77e30e0a","filename":"src/modules/sensors/rc_update.cpp","status":"modified","additions":18,"deletions":11,"changes":29,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/9e80a6c9d68661df1246daefcef44e895161cef3/src%2Fmodules%2Fsensors%2Frc_update.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/9e80a6c9d68661df1246daefcef44e895161cef3/src%2Fmodules%2Fsensors%2Frc_update.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fsensors%2Frc_update.cpp?ref=9e80a6c9d68661df1246daefcef44e895161cef3","patch":"@@ -47,17 +47,14 @@\n #include <uORB/topics/actuator_controls.h>\n #include <uORB/topics/manual_control_setpoint.h>\n \n-#define RC_SAMPLING_RATE 33.3f\n-#define RC_FILTER_LP_CUTOFF 5.0f\n-\n using namespace sensors;\n \n RCUpdate::RCUpdate(const Parameters &parameters)\n \t: _parameters(parameters),\n-\t  _filter_roll(RC_SAMPLING_RATE, RC_FILTER_LP_CUTOFF),\n-\t  _filter_pitch(RC_SAMPLING_RATE, RC_FILTER_LP_CUTOFF),\n-\t  _filter_yaw(RC_SAMPLING_RATE, RC_FILTER_LP_CUTOFF),\n-\t  _filter_throttle(RC_SAMPLING_RATE, RC_FILTER_LP_CUTOFF)\n+\t  _filter_roll(50.0f, 10.f), /* get replaced by parameter */\n+\t  _filter_pitch(50.0f, 10.f),\n+\t  _filter_yaw(50.0f, 10.f),\n+\t  _filter_throttle(50.0f, 10.f)\n {\n \tmemset(&_rc, 0, sizeof(_rc));\n \tmemset(&_rc_parameter_map, 0, sizeof(_rc_parameter_map));\n@@ -124,6 +121,10 @@ void RCUpdate::update_rc_functions()\n \t_filter_pitch.set_cutoff_frequency(_parameters.rc_flt_smp_rate, _parameters.rc_flt_cutoff);\n \t_filter_yaw.set_cutoff_frequency(_parameters.rc_flt_smp_rate, _parameters.rc_flt_cutoff);\n \t_filter_throttle.set_cutoff_frequency(_parameters.rc_flt_smp_rate, _parameters.rc_flt_cutoff);\n+\t_filter_roll.reset(0.f);\n+\t_filter_pitch.reset(0.f);\n+\t_filter_yaw.reset(0.f);\n+\t_filter_throttle.reset(0.f);\n }\n \n void\n@@ -365,17 +366,23 @@ RCUpdate::rc_poll(const ParameterHandles &parameter_handles)\n \t\t\tmanual.data_source = manual_control_setpoint_s::SOURCE_RC;\n \n \t\t\t/* limit controls */\n-\t\t\tmanual.y = _filter_roll.apply(get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_ROLL, -1.0, 1.0));\n-\t\t\tmanual.x = _filter_pitch.apply(get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_PITCH, -1.0, 1.0));\n-\t\t\tmanual.r = _filter_yaw.apply(get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_YAW, -1.0, 1.0));\n-\t\t\tmanual.z = _filter_throttle.apply(get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_THROTTLE, 0.0, 1.0));\n+\t\t\tmanual.y = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_ROLL, -1.0, 1.0);\n+\t\t\tmanual.x = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_PITCH, -1.0, 1.0);\n+\t\t\tmanual.r = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_YAW, -1.0, 1.0);\n+\t\t\tmanual.z = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_THROTTLE, 0.0, 1.0);\n \t\t\tmanual.flaps = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_FLAPS, -1.0, 1.0);\n \t\t\tmanual.aux1 = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_AUX_1, -1.0, 1.0);\n \t\t\tmanual.aux2 = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_AUX_2, -1.0, 1.0);\n \t\t\tmanual.aux3 = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_AUX_3, -1.0, 1.0);\n \t\t\tmanual.aux4 = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_AUX_4, -1.0, 1.0);\n \t\t\tmanual.aux5 = get_rc_value(rc_channels_s::RC_CHANNELS_FUNCTION_AUX_5, -1.0, 1.0);\n \n+\t\t\t/* filter controls */\n+\t\t\tmanual.y = math::constrain(_filter_roll.apply(manual.y), -1.f, 1.f);\n+\t\t\tmanual.x = math::constrain(_filter_pitch.apply(manual.x), -1.f, 1.f);\n+\t\t\tmanual.r = math::constrain(_filter_yaw.apply(manual.r), -1.f, 1.f);\n+\t\t\tmanual.z = math::constrain(_filter_throttle.apply(manual.z), 0.f, 1.f);\n+\n \t\t\tif (_parameters.rc_map_flightmode > 0) {\n \n \t\t\t\t/* the number of valid slots equals the index of the max marker minus one */"},{"sha":"2bea85bf1bf1b8fbe7bf8026b8510e31f09cf814","filename":"src/modules/sensors/sensor_params.c","status":"modified","additions":4,"deletions":2,"changes":6,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/9e80a6c9d68661df1246daefcef44e895161cef3/src%2Fmodules%2Fsensors%2Fsensor_params.c","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/9e80a6c9d68661df1246daefcef44e895161cef3/src%2Fmodules%2Fsensors%2Fsensor_params.c","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fsensors%2Fsensor_params.c?ref=9e80a6c9d68661df1246daefcef44e895161cef3","patch":"@@ -3358,8 +3358,10 @@ PARAM_DEFINE_FLOAT(RC_FLT_SMP_RATE, 50.0f);\n /**\n  * Cutoff frequency for the low pass filter on roll,pitch, yaw and throttle\n  *\n- * @min 1.0\n+ * Does not get set unless below RC_FLT_SMP_RATE/2 because of filter instability characteristics.\n+ *\n+ * @min 0.1\n  * @unit Hz\n  * @group Radio Calibration\n  */\n-PARAM_DEFINE_FLOAT(RC_FLT_CUTOFF, 5.0f);\n+PARAM_DEFINE_FLOAT(RC_FLT_CUTOFF, 10.0f);"}]}