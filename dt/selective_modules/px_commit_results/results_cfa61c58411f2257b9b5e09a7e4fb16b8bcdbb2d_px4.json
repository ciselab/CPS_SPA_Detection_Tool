{"sha":"cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d","node_id":"MDY6Q29tbWl0NTI5ODc5MDpjZmE2MWM1ODQxMWYyMjU3YjliNWUwOWE3ZTRmYjE2YjhiY2RiYjJk","commit":{"author":{"name":"Beat KÃ¼ng","email":"beat-kueng@gmx.net","date":"2017-05-12T12:35:37Z"},"committer":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2017-05-18T07:48:14Z"},"message":"MavlinkReceiver: add mission manager, param manager, ftp and log handler\n\nThis makes also a slight stack size increase necessary (was 284 bytes left)","tree":{"sha":"61fc0f0095283f8abf2d27ef178e62c709bfe913","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/61fc0f0095283f8abf2d27ef178e62c709bfe913"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d","html_url":"https://github.com/PX4/PX4-Autopilot/commit/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d/comments","author":{"login":"bkueng","id":281593,"node_id":"MDQ6VXNlcjI4MTU5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/281593?v=4","gravatar_id":"","url":"https://api.github.com/users/bkueng","html_url":"https://github.com/bkueng","followers_url":"https://api.github.com/users/bkueng/followers","following_url":"https://api.github.com/users/bkueng/following{/other_user}","gists_url":"https://api.github.com/users/bkueng/gists{/gist_id}","starred_url":"https://api.github.com/users/bkueng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bkueng/subscriptions","organizations_url":"https://api.github.com/users/bkueng/orgs","repos_url":"https://api.github.com/users/bkueng/repos","events_url":"https://api.github.com/users/bkueng/events{/privacy}","received_events_url":"https://api.github.com/users/bkueng/received_events","type":"User","site_admin":false},"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"d70caeb24b377194277a3347d3c70d9547a3cc52","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/d70caeb24b377194277a3347d3c70d9547a3cc52","html_url":"https://github.com/PX4/PX4-Autopilot/commit/d70caeb24b377194277a3347d3c70d9547a3cc52"}],"stats":{"total":44,"additions":42,"deletions":2},"files":[{"sha":"d2012f01189c880baf0779f953f5beb62d5c229b","filename":"src/modules/mavlink/mavlink_receiver.cpp","status":"modified","additions":33,"deletions":2,"changes":35,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d/src%2Fmodules%2Fmavlink%2Fmavlink_receiver.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d/src%2Fmodules%2Fmavlink%2Fmavlink_receiver.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fmavlink%2Fmavlink_receiver.cpp?ref=cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d","patch":"@@ -93,6 +93,10 @@ static const float mg2ms2 = CONSTANTS_ONE_G / 1000.0f;\n \n MavlinkReceiver::MavlinkReceiver(Mavlink *parent) :\n \t_mavlink(parent),\n+\t_mission_manager(parent),\n+\t_parameters_manager(parent),\n+\t_mavlink_ftp(parent),\n+\t_mavlink_log_handler(parent),\n \t_status{},\n \t_hil_local_pos{},\n \t_hil_land_detector{},\n@@ -2346,7 +2350,9 @@ MavlinkReceiver::receive_thread(void *arg)\n \t\tpx4_prctl(PR_SET_NAME, thread_name, px4_getpid());\n \t}\n \n-\tconst int timeout = 500;\n+\t// poll timeout in ms. Also defines the max update frequency of the mission & param manager, etc.\n+\tconst int timeout = 10;\n+\n #ifdef __PX4_POSIX\n \t/* 1500 is the Wifi MTU, so we make sure to fit a full packet */\n \tuint8_t buf[1600 * 5];\n@@ -2379,6 +2385,7 @@ MavlinkReceiver::receive_thread(void *arg)\n \n #endif\n \tssize_t nread = 0;\n+\thrt_abstime last_send_update = 0;\n \n \twhile (!_mavlink->_task_should_exit) {\n \t\tif (poll(&fds[0], 1, timeout) > 0) {\n@@ -2445,6 +2452,18 @@ MavlinkReceiver::receive_thread(void *arg)\n \t\t\t\t\t\t/* handle generic messages and commands */\n \t\t\t\t\t\thandle_message(&msg);\n \n+\t\t\t\t\t\t/* handle packet with mission manager */\n+\t\t\t\t\t\t_mission_manager.handle_message(&msg);\n+\n+\t\t\t\t\t\t/* handle packet with parameter component */\n+\t\t\t\t\t\t_parameters_manager.handle_message(&msg);\n+\n+\t\t\t\t\t\t/* handle packet with ftp component */\n+\t\t\t\t\t\t_mavlink_ftp.handle_message(&msg);\n+\n+\t\t\t\t\t\t/* handle packet with log component */\n+\t\t\t\t\t\t_mavlink_log_handler.handle_message(&msg);\n+\n \t\t\t\t\t\t/* handle packet with parent object */\n \t\t\t\t\t\t_mavlink->handle_message(&msg);\n \t\t\t\t\t}\n@@ -2456,6 +2475,18 @@ MavlinkReceiver::receive_thread(void *arg)\n \t\t\t\t}\n \t\t\t}\n \t\t}\n+\n+\t\thrt_abstime t = hrt_absolute_time();\n+\n+\t\tif (t - last_send_update > timeout * 1000) {\n+\t\t\t_mission_manager.check_active_mission();\n+\t\t\t_mission_manager.send(t);\n+\t\t\t_parameters_manager.send(t);\n+\t\t\t_mavlink_ftp.send(t);\n+\t\t\t_mavlink_log_handler.send(t);\n+\t\t\tlast_send_update = t;\n+\t\t}\n+\n \t}\n \n \treturn nullptr;\n@@ -2516,7 +2547,7 @@ MavlinkReceiver::receive_start(pthread_t *thread, Mavlink *parent)\n \tparam.sched_priority = SCHED_PRIORITY_MAX - 80;\n \t(void)pthread_attr_setschedparam(&receiveloop_attr, &param);\n \n-\tpthread_attr_setstacksize(&receiveloop_attr, PX4_STACK_ADJUSTED(2100));\n+\tpthread_attr_setstacksize(&receiveloop_attr, PX4_STACK_ADJUSTED(2140));\n \tpthread_create(thread, &receiveloop_attr, MavlinkReceiver::start_helper, (void *)parent);\n \n \tpthread_attr_destroy(&receiveloop_attr);"},{"sha":"42703927755d0f5d8cfec7820983f2222c7cafd4","filename":"src/modules/mavlink/mavlink_receiver.h","status":"modified","additions":9,"deletions":0,"changes":9,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d/src%2Fmodules%2Fmavlink%2Fmavlink_receiver.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d/src%2Fmodules%2Fmavlink%2Fmavlink_receiver.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fmavlink%2Fmavlink_receiver.h?ref=cfa61c58411f2257b9b5e09a7e4fb16b8bcdbb2d","patch":"@@ -80,7 +80,10 @@\n #include <uORB/topics/collision_report.h>\n \n \n+#include \"mavlink_mission.h\"\n+#include \"mavlink_parameters.h\"\n #include \"mavlink_ftp.h\"\n+#include \"mavlink_log_handler.h\"\n \n #define PX4_EPOCH_SECS 1234567890ULL\n \n@@ -188,6 +191,12 @@ class MavlinkReceiver\n \tbool\tevaluate_target_ok(int command, int target_system, int target_component);\n \n \tMavlink\t*_mavlink;\n+\n+\tMavlinkMissionManager\t\t_mission_manager;\n+\tMavlinkParametersManager\t_parameters_manager;\n+\tMavlinkFTP\t\t\t_mavlink_ftp;\n+\tMavlinkLogHandler\t\t_mavlink_log_handler;\n+\n \tmavlink_status_t _status; ///< receiver status, used for mavlink_parse_char()\n \tstruct vehicle_local_position_s _hil_local_pos;\n \tstruct vehicle_land_detected_s _hil_land_detector;"}]}