{"sha":"11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","node_id":"MDY6Q29tbWl0NTI5ODc5MDoxMWM2ZWUyYjVhOTExNWIwYjBlNjcyN2JkNmYyZGY1NzRhZDQ0N2Yz","commit":{"author":{"name":"tumbili","email":"bapstr@ethz.ch","date":"2015-10-14T15:14:38Z"},"committer":{"name":"Roman","email":"bapstr@ethz.ch","date":"2015-11-17T21:28:08Z"},"message":"make terrain estimate invalid after range sensor timeout","tree":{"sha":"1a6fcbb7d6e1a5d4dfead4698b2e712a69d3e4aa","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/1a6fcbb7d6e1a5d4dfead4698b2e712a69d3e4aa"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","html_url":"https://github.com/PX4/PX4-Autopilot/commit/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/comments","author":{"login":"RomanBapst","id":7610489,"node_id":"MDQ6VXNlcjc2MTA0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/7610489?v=4","gravatar_id":"","url":"https://api.github.com/users/RomanBapst","html_url":"https://github.com/RomanBapst","followers_url":"https://api.github.com/users/RomanBapst/followers","following_url":"https://api.github.com/users/RomanBapst/following{/other_user}","gists_url":"https://api.github.com/users/RomanBapst/gists{/gist_id}","starred_url":"https://api.github.com/users/RomanBapst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RomanBapst/subscriptions","organizations_url":"https://api.github.com/users/RomanBapst/orgs","repos_url":"https://api.github.com/users/RomanBapst/repos","events_url":"https://api.github.com/users/RomanBapst/events{/privacy}","received_events_url":"https://api.github.com/users/RomanBapst/received_events","type":"User","site_admin":false},"committer":{"login":"RomanBapst","id":7610489,"node_id":"MDQ6VXNlcjc2MTA0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/7610489?v=4","gravatar_id":"","url":"https://api.github.com/users/RomanBapst","html_url":"https://github.com/RomanBapst","followers_url":"https://api.github.com/users/RomanBapst/followers","following_url":"https://api.github.com/users/RomanBapst/following{/other_user}","gists_url":"https://api.github.com/users/RomanBapst/gists{/gist_id}","starred_url":"https://api.github.com/users/RomanBapst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RomanBapst/subscriptions","organizations_url":"https://api.github.com/users/RomanBapst/orgs","repos_url":"https://api.github.com/users/RomanBapst/repos","events_url":"https://api.github.com/users/RomanBapst/events{/privacy}","received_events_url":"https://api.github.com/users/RomanBapst/received_events","type":"User","site_admin":false},"parents":[{"sha":"1ae722159332da0fa0abf1cbd939ea0670e6b2fe","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/1ae722159332da0fa0abf1cbd939ea0670e6b2fe","html_url":"https://github.com/PX4/PX4-Autopilot/commit/1ae722159332da0fa0abf1cbd939ea0670e6b2fe"}],"stats":{"total":13,"additions":10,"deletions":3},"files":[{"sha":"16ab8de4a040064ecce9331f00673cfd9b9f1d70","filename":"src/lib/terrain_estimation/terrain_estimator.cpp","status":"modified","additions":8,"deletions":1,"changes":9,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/src%2Flib%2Fterrain_estimation%2Fterrain_estimator.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/src%2Flib%2Fterrain_estimation%2Fterrain_estimator.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Flib%2Fterrain_estimation%2Fterrain_estimator.cpp?ref=11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","patch":"@@ -38,6 +38,8 @@\n \n #include \"terrain_estimator.h\"\n \n+#define DISTANCE_TIMEOUT 100000\t\t// time in usec after which laser is considered dead\n+\n TerrainEstimator::TerrainEstimator() :\n \t_distance_last(0.0f),\n \t_terrain_valid(false),\n@@ -100,9 +102,14 @@ void TerrainEstimator::predict(float dt, const struct vehicle_attitude_s *attitu\n \t       B * R * B.transposed() + Q) * dt;\n }\n \n-void TerrainEstimator::measurement_update(const struct vehicle_gps_position_s *gps, const struct distance_sensor_s *distance,\n+void TerrainEstimator::measurement_update(uint64_t time_ref, const struct vehicle_gps_position_s *gps, const struct distance_sensor_s *distance,\n \t\t\t\tconst struct vehicle_attitude_s *attitude)\n {\n+\t// terrain estimate is invalid if we have range sensor timeout\n+\tif (time_ref - distance->timestamp > DISTANCE_TIMEOUT) {\n+\t\t_terrain_valid = false;\n+\t}\n+\n \tif (distance->timestamp > _time_last_distance) {\n \n \t\tfloat d = distance->current_distance;"},{"sha":"fc10cb8d63f234a4147b59c35a60f9136ee9bd7a","filename":"src/lib/terrain_estimation/terrain_estimator.h","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/src%2Flib%2Fterrain_estimation%2Fterrain_estimator.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/src%2Flib%2Fterrain_estimation%2Fterrain_estimator.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Flib%2Fterrain_estimation%2Fterrain_estimator.h?ref=11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","patch":"@@ -65,7 +65,7 @@ class __EXPORT TerrainEstimator\n \n \tvoid predict(float dt, const struct vehicle_attitude_s *attitude, const struct sensor_combined_s *sensor,\n \t\tconst struct distance_sensor_s *distance);\n-\tvoid measurement_update(const struct vehicle_gps_position_s *gps, const struct distance_sensor_s *distance,\n+\tvoid measurement_update(uint64_t time_ref, const struct vehicle_gps_position_s *gps, const struct distance_sensor_s *distance,\n \t\t\t\tconst struct vehicle_attitude_s *attitude);\n \n private:"},{"sha":"e4c8eeccdec3f925e6eadc8b9dae37f59d8e5b0f","filename":"src/modules/ekf_att_pos_estimator/ekf_att_pos_estimator_main.cpp","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/src%2Fmodules%2Fekf_att_pos_estimator%2Fekf_att_pos_estimator_main.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3/src%2Fmodules%2Fekf_att_pos_estimator%2Fekf_att_pos_estimator_main.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fekf_att_pos_estimator%2Fekf_att_pos_estimator_main.cpp?ref=11c6ee2b5a9115b0b0e6727bd6f2df574ad447f3","patch":"@@ -702,7 +702,7 @@ void AttitudePositionEstimatorEKF::task_main()\n \n \t\t\t\t\t// Run separate terrain estimator\n \t\t\t\t\t_terrain_estimator->predict(_ekf->dtIMU, &_att, &_sensor_combined, &_distance);\n-\t\t\t\t\t_terrain_estimator->measurement_update(&_gps, &_distance, &_att);\n+\t\t\t\t\t_terrain_estimator->measurement_update(hrt_absolute_time(), &_gps, &_distance, &_att);\n \n \t\t\t\t\t// Publish attitude estimations\n \t\t\t\t\tpublishAttitude();"}]}