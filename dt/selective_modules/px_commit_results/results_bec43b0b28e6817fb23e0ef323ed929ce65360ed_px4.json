{"sha":"bec43b0b28e6817fb23e0ef323ed929ce65360ed","node_id":"MDY6Q29tbWl0NTI5ODc5MDpiZWM0M2IwYjI4ZTY4MTdmYjIzZTBlZjMyM2VkOTI5Y2U2NTM2MGVk","commit":{"author":{"name":"Beat KÃ¼ng","email":"beat-kueng@gmx.net","date":"2018-10-25T05:56:55Z"},"committer":{"name":"Daniel Agar","email":"daniel@agar.ca","date":"2018-10-31T00:20:25Z"},"message":"mc_att_control: run rate controller first and increase fmu prio by one\n\nThe rate controller is now run directly after a gyro publication, and\nas soon as it publishes the actuator controls, the output driver (fmu/...)\nruns.\n\nTest on a Pixracer:\nReduces fmu control latency from 219us to 134us.\nIf we run the rate controller last (same order as before, just increase\nthe prio), the latency is 201us.\n\nCPU load is unchanged.\n\nThe drawback is that the attitude to rate setpoint generation is delayed\nby one cycle (4ms), but it will be reduced to 1ms as soon as we run at\n1kHz.","tree":{"sha":"23c469b4365086680d33372f224192d9fc84f564","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/23c469b4365086680d33372f224192d9fc84f564"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/bec43b0b28e6817fb23e0ef323ed929ce65360ed","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/bec43b0b28e6817fb23e0ef323ed929ce65360ed","html_url":"https://github.com/PX4/PX4-Autopilot/commit/bec43b0b28e6817fb23e0ef323ed929ce65360ed","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/bec43b0b28e6817fb23e0ef323ed929ce65360ed/comments","author":{"login":"bkueng","id":281593,"node_id":"MDQ6VXNlcjI4MTU5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/281593?v=4","gravatar_id":"","url":"https://api.github.com/users/bkueng","html_url":"https://github.com/bkueng","followers_url":"https://api.github.com/users/bkueng/followers","following_url":"https://api.github.com/users/bkueng/following{/other_user}","gists_url":"https://api.github.com/users/bkueng/gists{/gist_id}","starred_url":"https://api.github.com/users/bkueng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bkueng/subscriptions","organizations_url":"https://api.github.com/users/bkueng/orgs","repos_url":"https://api.github.com/users/bkueng/repos","events_url":"https://api.github.com/users/bkueng/events{/privacy}","received_events_url":"https://api.github.com/users/bkueng/received_events","type":"User","site_admin":false},"committer":{"login":"dagar","id":84712,"node_id":"MDQ6VXNlcjg0NzEy","avatar_url":"https://avatars.githubusercontent.com/u/84712?v=4","gravatar_id":"","url":"https://api.github.com/users/dagar","html_url":"https://github.com/dagar","followers_url":"https://api.github.com/users/dagar/followers","following_url":"https://api.github.com/users/dagar/following{/other_user}","gists_url":"https://api.github.com/users/dagar/gists{/gist_id}","starred_url":"https://api.github.com/users/dagar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dagar/subscriptions","organizations_url":"https://api.github.com/users/dagar/orgs","repos_url":"https://api.github.com/users/dagar/repos","events_url":"https://api.github.com/users/dagar/events{/privacy}","received_events_url":"https://api.github.com/users/dagar/received_events","type":"User","site_admin":false},"parents":[{"sha":"95cc6a06f310061c3261bfb422f97a14187166ad","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/95cc6a06f310061c3261bfb422f97a14187166ad","html_url":"https://github.com/PX4/PX4-Autopilot/commit/95cc6a06f310061c3261bfb422f97a14187166ad"}],"stats":{"total":21,"additions":11,"deletions":10},"files":[{"sha":"7c6a82047b75b20e2d36f43aa20ad89345fef818","filename":"src/modules/mc_att_control/mc_att_control_main.cpp","status":"modified","additions":8,"deletions":7,"changes":15,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bec43b0b28e6817fb23e0ef323ed929ce65360ed/src%2Fmodules%2Fmc_att_control%2Fmc_att_control_main.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bec43b0b28e6817fb23e0ef323ed929ce65360ed/src%2Fmodules%2Fmc_att_control%2Fmc_att_control_main.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fmc_att_control%2Fmc_att_control_main.cpp?ref=bec43b0b28e6817fb23e0ef323ed929ce65360ed","patch":"@@ -720,6 +720,14 @@ MulticopterAttitudeControl::run()\n \t\t\t/* copy gyro data */\n \t\t\torb_copy(ORB_ID(sensor_gyro), _sensor_gyro_sub[_selected_gyro], &_sensor_gyro);\n \n+\t\t\t/* run the rate controller immediately after a gyro update */\n+\t\t\tif (_v_control_mode.flag_control_rates_enabled) {\n+\t\t\t\tcontrol_attitude_rates(dt);\n+\n+\t\t\t\tpublish_actuator_controls();\n+\t\t\t\tpublish_rate_controller_status();\n+\t\t\t}\n+\n \t\t\t/* check for updates in other topics */\n \t\t\tvehicle_control_mode_poll();\n \t\t\tvehicle_status_poll();\n@@ -772,13 +780,6 @@ MulticopterAttitudeControl::run()\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (_v_control_mode.flag_control_rates_enabled) {\n-\t\t\t\tcontrol_attitude_rates(dt);\n-\n-\t\t\t\tpublish_actuator_controls();\n-\t\t\t\tpublish_rate_controller_status();\n-\t\t\t}\n-\n \t\t\tif (_v_control_mode.flag_control_termination_enabled) {\n \t\t\t\tif (!_vehicle_status.is_vtol) {\n \t\t\t\t\t_rates_sp.zero();"},{"sha":"99822e764ae667cc1670d3b2e021e58fb7dc1c4a","filename":"src/platforms/px4_tasks.h","status":"modified","additions":3,"deletions":3,"changes":6,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bec43b0b28e6817fb23e0ef323ed929ce65360ed/src%2Fplatforms%2Fpx4_tasks.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bec43b0b28e6817fb23e0ef323ed929ce65360ed/src%2Fplatforms%2Fpx4_tasks.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fplatforms%2Fpx4_tasks.h?ref=bec43b0b28e6817fb23e0ef323ed929ce65360ed","patch":"@@ -114,9 +114,9 @@ typedef struct {\n // which typically runs at a slower rate\n #define SCHED_PRIORITY_ATTITUDE_CONTROL\t\t(SCHED_PRIORITY_MAX - 4)\n \n-// Actuator outputs should run before right after the attitude controller\n-// updated\n-#define SCHED_PRIORITY_ACTUATOR_OUTPUTS\t\t(SCHED_PRIORITY_MAX - 4)\n+// Actuator outputs should run as soon as the rate controller publishes\n+// the actuator controls topic\n+#define SCHED_PRIORITY_ACTUATOR_OUTPUTS\t\t(SCHED_PRIORITY_MAX - 3)\n \n // Position controllers typically are in a blocking wait on estimator data\n // so when new sensor data is available they will run last. Keeping them"}]}