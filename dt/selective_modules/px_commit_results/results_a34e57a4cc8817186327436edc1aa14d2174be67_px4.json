{"sha":"a34e57a4cc8817186327436edc1aa14d2174be67","node_id":"MDY6Q29tbWl0NTI5ODc5MDphMzRlNTdhNGNjODgxNzE4NjMyNzQzNmVkYzFhYTE0ZDIxNzRiZTY3","commit":{"author":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2020-12-30T22:05:34Z"},"committer":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2020-12-31T00:05:30Z"},"message":"Simulator: Increase stack, publication affinity\nThis commit increases the send thread stack size and changes the thread affinity of the lockstep clocking topic. It also improves verbosity in case error states occur.","tree":{"sha":"7f784ea760cc9a7d55d58236bf94cbd7474aa396","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/7f784ea760cc9a7d55d58236bf94cbd7474aa396"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/a34e57a4cc8817186327436edc1aa14d2174be67","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/a34e57a4cc8817186327436edc1aa14d2174be67","html_url":"https://github.com/PX4/PX4-Autopilot/commit/a34e57a4cc8817186327436edc1aa14d2174be67","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/a34e57a4cc8817186327436edc1aa14d2174be67/comments","author":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"fda63f802ecd8dad436bd119032aceccd74fbcc1","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/fda63f802ecd8dad436bd119032aceccd74fbcc1","html_url":"https://github.com/PX4/PX4-Autopilot/commit/fda63f802ecd8dad436bd119032aceccd74fbcc1"}],"stats":{"total":19,"additions":10,"deletions":9},"files":[{"sha":"9853194d5a1260b739108df7664607d2ff9ea768","filename":"src/modules/simulator/simulator_mavlink.cpp","status":"modified","additions":10,"deletions":9,"changes":19,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/a34e57a4cc8817186327436edc1aa14d2174be67/src%2Fmodules%2Fsimulator%2Fsimulator_mavlink.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/a34e57a4cc8817186327436edc1aa14d2174be67/src%2Fmodules%2Fsimulator%2Fsimulator_mavlink.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fsimulator%2Fsimulator_mavlink.cpp?ref=a34e57a4cc8817186327436edc1aa14d2174be67","patch":"@@ -594,6 +594,10 @@ void Simulator::send()\n \tpthread_setname_np(pthread_self(), \"sim_send\");\n #endif\n \n+\t// Subscribe to topics.\n+\t// Only subscribe to the first actuator_outputs to fill a single HIL_ACTUATOR_CONTROLS.\n+\t_actuator_outputs_sub = orb_subscribe_multi(ORB_ID(actuator_outputs), 0);\n+\n \t// Before starting, we ought to send a heartbeat to initiate the SITL\n \t// simulator to start sending sensor data which will set the time and\n \t// get everything rolling.\n@@ -631,6 +635,8 @@ void Simulator::send()\n \t\t\tsend_controls();\n \t\t}\n \t}\n+\n+\torb_unsubscribe(_actuator_outputs_sub);\n }\n \n void Simulator::request_hil_state_quaternion()\n@@ -691,7 +697,7 @@ void Simulator::run()\n \t\t\t\tbreak;\n \n \t\t\t} else {\n-\t\t\t\tsystem_usleep(100);\n+\t\t\t\tsystem_usleep(500);\n \t\t\t}\n \t\t}\n \n@@ -722,7 +728,7 @@ void Simulator::run()\n \n \t\t\t} else {\n \t\t\t\t::close(_fd);\n-\t\t\t\tsystem_usleep(100);\n+\t\t\t\tsystem_usleep(500);\n \t\t\t}\n \t\t}\n \n@@ -735,7 +741,7 @@ void Simulator::run()\n \n \tpthread_attr_t sender_thread_attr;\n \tpthread_attr_init(&sender_thread_attr);\n-\tpthread_attr_setstacksize(&sender_thread_attr, PX4_STACK_ADJUSTED(4000));\n+\tpthread_attr_setstacksize(&sender_thread_attr, PX4_STACK_ADJUSTED(8000));\n \n \tstruct sched_param param;\n \t(void)pthread_attr_getschedparam(&sender_thread_attr, &param);\n@@ -769,10 +775,6 @@ void Simulator::run()\n \n #endif\n \n-\t// Subscribe to topics.\n-\t// Only subscribe to the first actuator_outputs to fill a single HIL_ACTUATOR_CONTROLS.\n-\t_actuator_outputs_sub = orb_subscribe_multi(ORB_ID(actuator_outputs), 0);\n-\n \t// got data from simulator, now activate the sending thread\n \tpthread_create(&sender_thread, &sender_thread_attr, Simulator::sending_trampoline, nullptr);\n \tpthread_attr_destroy(&sender_thread_attr);\n@@ -789,6 +791,7 @@ void Simulator::run()\n \n \t\tif (pret == 0) {\n \t\t\t// Timed out.\n+\t\t\tPX4_ERR(\"poll timeout %d, %d\", pret, errno);\n \t\t\tcontinue;\n \t\t}\n \n@@ -833,8 +836,6 @@ void Simulator::run()\n \n #endif\n \t}\n-\n-\torb_unsubscribe(_actuator_outputs_sub);\n }\n \n #ifdef ENABLE_UART_RC_INPUT"}]}