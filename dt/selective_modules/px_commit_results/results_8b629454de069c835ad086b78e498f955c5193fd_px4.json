{"sha":"8b629454de069c835ad086b78e498f955c5193fd","node_id":"MDY6Q29tbWl0NTI5ODc5MDo4YjYyOTQ1NGRlMDY5YzgzNWFkMDg2Yjc4ZTQ5OGY5NTVjNTE5M2Zk","commit":{"author":{"name":"Roman","email":"bapstroman@gmail.com","date":"2018-04-20T13:06:56Z"},"committer":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2018-07-03T07:05:38Z"},"message":"esc_calibration: increase safety and initialise all data\n- do not do calibration if not very sure that battery is not connected\n- initialise all structs and variables\n\nSigned-off-by: Roman <bapstroman@gmail.com>","tree":{"sha":"043b7e30e9cae4eadbbfe419a25e4e3c063ec20a","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/043b7e30e9cae4eadbbfe419a25e4e3c063ec20a"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/8b629454de069c835ad086b78e498f955c5193fd","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/8b629454de069c835ad086b78e498f955c5193fd","html_url":"https://github.com/PX4/PX4-Autopilot/commit/8b629454de069c835ad086b78e498f955c5193fd","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/8b629454de069c835ad086b78e498f955c5193fd/comments","author":{"login":"RomanBapst","id":7610489,"node_id":"MDQ6VXNlcjc2MTA0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/7610489?v=4","gravatar_id":"","url":"https://api.github.com/users/RomanBapst","html_url":"https://github.com/RomanBapst","followers_url":"https://api.github.com/users/RomanBapst/followers","following_url":"https://api.github.com/users/RomanBapst/following{/other_user}","gists_url":"https://api.github.com/users/RomanBapst/gists{/gist_id}","starred_url":"https://api.github.com/users/RomanBapst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RomanBapst/subscriptions","organizations_url":"https://api.github.com/users/RomanBapst/orgs","repos_url":"https://api.github.com/users/RomanBapst/repos","events_url":"https://api.github.com/users/RomanBapst/events{/privacy}","received_events_url":"https://api.github.com/users/RomanBapst/received_events","type":"User","site_admin":false},"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"e1117d175b61f942bbe3563deeac49ddec13371d","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/e1117d175b61f942bbe3563deeac49ddec13371d","html_url":"https://github.com/PX4/PX4-Autopilot/commit/e1117d175b61f942bbe3563deeac49ddec13371d"}],"stats":{"total":39,"additions":16,"deletions":23},"files":[{"sha":"039313b51bef360df4a401349935e961c44d439a","filename":"src/modules/commander/esc_calibration.cpp","status":"modified","additions":16,"deletions":22,"changes":38,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/8b629454de069c835ad086b78e498f955c5193fd/src%2Fmodules%2Fcommander%2Fesc_calibration.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/8b629454de069c835ad086b78e498f955c5193fd/src%2Fmodules%2Fcommander%2Fesc_calibration.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fcommander%2Fesc_calibration.cpp?ref=8b629454de069c835ad086b78e498f955c5193fd","patch":"@@ -61,25 +61,12 @@\n #include <drivers/drv_hrt.h>\n #include <systemlib/mavlink_log.h>\n \n-int check_if_batt_disconnected(orb_advert_t *mavlink_log_pub) {\n-\tstruct battery_status_s battery;\n-\tmemset(&battery,0,sizeof(battery));\n-\tint batt_sub = orb_subscribe(ORB_ID(battery_status));\n-\torb_copy(ORB_ID(battery_status), batt_sub, &battery);\n-\n-\tif (battery.voltage_filtered_v > 3.0f && !(hrt_absolute_time() - battery.timestamp > 500000)) {\n-\t\tmavlink_log_info(mavlink_log_pub, \"Please disconnect battery and try again!\");\n-\t\treturn PX4_ERROR;\n-\t}\n-\treturn PX4_OK;\n-}\n-\n int do_esc_calibration(orb_advert_t *mavlink_log_pub, struct actuator_armed_s* armed)\n {\n \tint\treturn_code = PX4_OK;\n \t\n #if defined(__PX4_POSIX_OCPOC)\n-\thrt_abstime timeout_start;\n+\thrt_abstime timeout_start = 0;\n \thrt_abstime timeout_wait = 60*1000*1000;\n \tarmed->in_esc_calibration_mode = true;\n \tcalibration_log_info(mavlink_log_pub, CAL_QGC_DONE_MSG, \"begin esc\");\n@@ -105,14 +92,14 @@ int do_esc_calibration(orb_advert_t *mavlink_log_pub, struct actuator_armed_s* a\n #else\n \tint\tfd = -1;\n \n-\tstruct\tbattery_status_s battery;\n+\tstruct\tbattery_status_s battery = {};\n \tint\tbatt_sub = -1;\n \tbool\tbatt_updated = false;\n-\tbool\tbatt_connected = false;\n+\tbool\tbatt_connected = true;\t// for safety resons assume battery is connected, will be cleared below if not the case\n \n-\thrt_abstime battery_connect_wait_timeout = 30000000;\n-\thrt_abstime pwm_high_timeout = 3000000;\n-\thrt_abstime timeout_start;\n+\thrt_abstime battery_connect_wait_timeout = 30*1000*1000;\n+\thrt_abstime pwm_high_timeout = 3*1000*1000;\n+\thrt_abstime timeout_start = 0;\n \n \tcalibration_log_info(mavlink_log_pub, CAL_QGC_STARTED_MSG, \"esc\");\n \n@@ -123,8 +110,15 @@ int do_esc_calibration(orb_advert_t *mavlink_log_pub, struct actuator_armed_s* a\n \t}\n \n \t// Make sure battery is disconnected\n-\torb_copy(ORB_ID(battery_status), batt_sub, &battery);\n-\tif (battery.voltage_filtered_v > 3.0f) {\n+\tif (orb_copy(ORB_ID(battery_status), batt_sub, &battery) == PX4_OK) {\n+\n+\t\t// battery is not connected if voltage is lower than 3V and we have a recent battery measurement\n+\t\tif (battery.voltage_filtered_v < 3.0f && (hrt_absolute_time() - battery.timestamp < 500*1000)) {\n+\t\t\tbatt_connected = false;\n+\t\t}\n+\t}\n+\n+\tif (batt_connected) {\n \t\tcalibration_log_critical(mavlink_log_pub, CAL_QGC_FAILED_MSG, \"Disconnect battery and try again\");\n \t\tgoto Error;\n \t}\n@@ -187,7 +181,7 @@ int do_esc_calibration(orb_advert_t *mavlink_log_pub, struct actuator_armed_s* a\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-\t\tusleep(50000);\n+\t\tusleep(50*1000);\n \t}\n \n Out:"},{"sha":"c7c7b84bbff6384cb65bb890053d977dfa195289","filename":"src/modules/commander/esc_calibration.h","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/8b629454de069c835ad086b78e498f955c5193fd/src%2Fmodules%2Fcommander%2Fesc_calibration.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/8b629454de069c835ad086b78e498f955c5193fd/src%2Fmodules%2Fcommander%2Fesc_calibration.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fcommander%2Fesc_calibration.h?ref=8b629454de069c835ad086b78e498f955c5193fd","patch":"@@ -44,7 +44,6 @@\n \n #include <uORB/topics/actuator_armed.h>\n \n-int check_if_batt_disconnected(orb_advert_t *mavlink_log_pub);\n int do_esc_calibration(orb_advert_t *mavlink_log_pub, struct actuator_armed_s* armed);\n \n #endif"}]}