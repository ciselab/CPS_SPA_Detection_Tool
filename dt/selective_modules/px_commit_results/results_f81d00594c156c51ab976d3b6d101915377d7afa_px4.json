{"sha":"f81d00594c156c51ab976d3b6d101915377d7afa","node_id":"MDY6Q29tbWl0NTI5ODc5MDpmODFkMDA1OTRjMTU2YzUxYWI5NzZkM2I2ZDEwMTkxNTM3N2Q3YWZh","commit":{"author":{"name":"Lorenz Meier","email":"lm@inf.ethz.ch","date":"2012-12-15T22:28:03Z"},"committer":{"name":"Lorenz Meier","email":"lm@inf.ethz.ch","date":"2012-12-15T22:28:03Z"},"message":"Made PX4IO FMU timeout based on IOs HRT, updating mixers now on every FMU update and not at fixed rate, this is WIP and currently does not support mixing with RC-only","tree":{"sha":"041ff3b3d54ca5c2f7a995eadcbc2e58af1e56ba","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/041ff3b3d54ca5c2f7a995eadcbc2e58af1e56ba"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/f81d00594c156c51ab976d3b6d101915377d7afa","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/f81d00594c156c51ab976d3b6d101915377d7afa","html_url":"https://github.com/PX4/PX4-Autopilot/commit/f81d00594c156c51ab976d3b6d101915377d7afa","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/f81d00594c156c51ab976d3b6d101915377d7afa/comments","author":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"42ffb4161d4cec9e1d290d0191e7a4bb89546ed9","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/42ffb4161d4cec9e1d290d0191e7a4bb89546ed9","html_url":"https://github.com/PX4/PX4-Autopilot/commit/42ffb4161d4cec9e1d290d0191e7a4bb89546ed9"}],"stats":{"total":35,"additions":15,"deletions":20},"files":[{"sha":"9a786234eec5faa83a8c82a3d79d712bfe2772f4","filename":"apps/px4io/comms.c","status":"modified","additions":4,"deletions":1,"changes":5,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fcomms.c","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fcomms.c","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/apps%2Fpx4io%2Fcomms.c?ref=f81d00594c156c51ab976d3b6d101915377d7afa","patch":"@@ -183,7 +183,7 @@ comms_handle_command(const void *buffer, size_t length)\n \tsystem_state.vector_flight_mode_ok = cmd->vector_flight_mode_ok;\n \tsystem_state.manual_override_ok = cmd->manual_override_ok;\n \tsystem_state.mixer_fmu_available = true;\n-\tsystem_state.fmu_data_received = true;\n+\tsystem_state.fmu_data_received_time = hrt_absolute_time();\n \n \t/* set PWM update rate if changed (after limiting) */\n \tuint16_t new_servo_rate = cmd->servo_rate;\n@@ -201,6 +201,9 @@ comms_handle_command(const void *buffer, size_t length)\n \t\tsystem_state.servo_rate = new_servo_rate;\n \t}\n \n+\t/* update servo values immediately */\n+\tmixer_tick();\n+\n \t/* XXX do relay changes here */\t\n \tfor (unsigned i = 0; i < PX4IO_RELAY_CHANNELS; i++) {\n \t\tsystem_state.relays[i] = cmd->relay_state[i];"},{"sha":"4bd6fe1a0fbca213a9b5f46ecbcc36a001aee1d3","filename":"apps/px4io/controls.c","status":"modified","additions":3,"deletions":4,"changes":7,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fcontrols.c","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fcontrols.c","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/apps%2Fpx4io%2Fcontrols.c?ref=f81d00594c156c51ab976d3b6d101915377d7afa","patch":"@@ -61,8 +61,8 @@\n #include \"px4io.h\"\n \n #define RC_FAILSAFE_TIMEOUT\t\t2000000\t\t/**< two seconds failsafe timeout */\n-#define RC_CHANNEL_HIGH_THRESH\t\t1600\n-#define RC_CHANNEL_LOW_THRESH\t\t1400\n+#define RC_CHANNEL_HIGH_THRESH\t\t1700\n+#define RC_CHANNEL_LOW_THRESH\t\t1300\n \n static void\tppm_input(void);\n \n@@ -133,8 +133,7 @@ controls_main(void)\n \t\t\tsystem_state.fmu_report_due = true;\n \t\t}\n \n-\t\t/* do PWM output updates */\n-\t\tmixer_tick();\n+\t\t/* PWM output updates are performed directly on each comms update */\n \t}\n }\n "},{"sha":"318183ef541f1b2cd175e0e7b99687517c057d00","filename":"apps/px4io/mixer.c","status":"modified","additions":6,"deletions":13,"changes":19,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fmixer.c","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fmixer.c","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/apps%2Fpx4io%2Fmixer.c?ref=f81d00594c156c51ab976d3b6d101915377d7afa","patch":"@@ -53,10 +53,9 @@\n #include \"px4io.h\"\n \n /*\n- * Count of periodic calls in which we have no FMU input.\n+ * Maximum interval in us before FMU signal is considered lost\n  */\n-static unsigned fmu_input_drops;\n-#define FMU_INPUT_DROP_LIMIT\t20\n+#define FMU_INPUT_DROP_LIMIT_US\t\t200000\n \n /*\n  * Update a mixer based on the current control signals.\n@@ -91,25 +90,19 @@ mixer_tick(void)\n \t\tcontrol_values = &system_state.fmu_channel_data[0];\n \n \t\t/* check that we are receiving fresh data from the FMU */\n-\t\tif (!system_state.fmu_data_received) {\n-\t\t\tfmu_input_drops++;\n+\t\tif ((hrt_absolute_time() - system_state.fmu_data_received_time) > FMU_INPUT_DROP_LIMIT_US) {\n \n \t\t\t/* too many frames without FMU input, time to go to failsafe */\n-\t\t\tif (fmu_input_drops >= FMU_INPUT_DROP_LIMIT) {\n-\t\t\t\tsystem_state.mixer_manual_override = true;\n-\t\t\t\tsystem_state.mixer_fmu_available = false;\n-\t\t\t}\n-\t\t} else {\n-\t\t\tfmu_input_drops = 0;\n-\t\t\tsystem_state.fmu_data_received = false;\n+\t\t\tsystem_state.mixer_manual_override = true;\n+\t\t\tsystem_state.mixer_fmu_available = false;\n \t\t}\n \n \t} else if (system_state.rc_channels > 0 && system_state.manual_override_ok) {\n \t\t/* we have control data from an R/C input */\n \t\tcontrol_count = system_state.rc_channels;\n \t\tcontrol_values = &system_state.rc_channel_data[0];\n \t} else {\n-\t\t/* we have no control input */\n+\t\t/* we have no control input (no FMU, no RC) */\n \n \t\t// XXX builtin failsafe would activate here \n \t\tcontrol_count = 0;"},{"sha":"c8699c6c6045ced178ccc9dd11e4b60296f9528c","filename":"apps/px4io/px4io.h","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fpx4io.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/f81d00594c156c51ab976d3b6d101915377d7afa/apps%2Fpx4io%2Fpx4io.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/apps%2Fpx4io%2Fpx4io.h?ref=f81d00594c156c51ab976d3b6d101915377d7afa","patch":"@@ -106,9 +106,9 @@ struct sys_state_s\n \tbool\t\tfmu_report_due;\n \n \t/**\n-\t * If true, new control data from the FMU has been received.\n+\t * Last FMU receive time, in microseconds since system boot\n \t */\n-\tbool\t\tfmu_data_received;\n+\tuint64_t\tfmu_data_received_time;\n \n \t/**\n \t * Current serial interface mode, per the serial_rx_mode parameter"}]}