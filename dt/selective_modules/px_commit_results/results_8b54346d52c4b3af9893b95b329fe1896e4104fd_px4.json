{"sha":"8b54346d52c4b3af9893b95b329fe1896e4104fd","node_id":"MDY6Q29tbWl0NTI5ODc5MDo4YjU0MzQ2ZDUyYzRiM2FmOTg5M2I5NWIzMjlmZTE4OTZlNDEwNGZk","commit":{"author":{"name":"DanielePettenuzzo","email":"daniele@px4.io","date":"2018-05-16T12:47:15Z"},"committer":{"name":"Beat KÃ¼ng","email":"beat-kueng@gmx.net","date":"2018-05-22T10:21:45Z"},"message":"mpu9250: decrease sampling rate when using i2c","tree":{"sha":"8313ec074f1038421f4597404b183887d6c90098","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/8313ec074f1038421f4597404b183887d6c90098"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/8b54346d52c4b3af9893b95b329fe1896e4104fd","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/8b54346d52c4b3af9893b95b329fe1896e4104fd","html_url":"https://github.com/PX4/PX4-Autopilot/commit/8b54346d52c4b3af9893b95b329fe1896e4104fd","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/8b54346d52c4b3af9893b95b329fe1896e4104fd/comments","author":{"login":"DanielePettenuzzo","id":35664507,"node_id":"MDQ6VXNlcjM1NjY0NTA3","avatar_url":"https://avatars.githubusercontent.com/u/35664507?v=4","gravatar_id":"","url":"https://api.github.com/users/DanielePettenuzzo","html_url":"https://github.com/DanielePettenuzzo","followers_url":"https://api.github.com/users/DanielePettenuzzo/followers","following_url":"https://api.github.com/users/DanielePettenuzzo/following{/other_user}","gists_url":"https://api.github.com/users/DanielePettenuzzo/gists{/gist_id}","starred_url":"https://api.github.com/users/DanielePettenuzzo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DanielePettenuzzo/subscriptions","organizations_url":"https://api.github.com/users/DanielePettenuzzo/orgs","repos_url":"https://api.github.com/users/DanielePettenuzzo/repos","events_url":"https://api.github.com/users/DanielePettenuzzo/events{/privacy}","received_events_url":"https://api.github.com/users/DanielePettenuzzo/received_events","type":"User","site_admin":false},"committer":{"login":"bkueng","id":281593,"node_id":"MDQ6VXNlcjI4MTU5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/281593?v=4","gravatar_id":"","url":"https://api.github.com/users/bkueng","html_url":"https://github.com/bkueng","followers_url":"https://api.github.com/users/bkueng/followers","following_url":"https://api.github.com/users/bkueng/following{/other_user}","gists_url":"https://api.github.com/users/bkueng/gists{/gist_id}","starred_url":"https://api.github.com/users/bkueng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bkueng/subscriptions","organizations_url":"https://api.github.com/users/bkueng/orgs","repos_url":"https://api.github.com/users/bkueng/repos","events_url":"https://api.github.com/users/bkueng/events{/privacy}","received_events_url":"https://api.github.com/users/bkueng/received_events","type":"User","site_admin":false},"parents":[{"sha":"9c8e97a1bae664a983468d0f6c9dec310e98e7c6","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/9c8e97a1bae664a983468d0f6c9dec310e98e7c6","html_url":"https://github.com/PX4/PX4-Autopilot/commit/9c8e97a1bae664a983468d0f6c9dec310e98e7c6"}],"stats":{"total":33,"additions":24,"deletions":9},"files":[{"sha":"2ed36591fbbde0c752661584c9157e36ed7fb204","filename":"src/drivers/imu/mpu9250/mpu9250.cpp","status":"modified","additions":11,"deletions":4,"changes":15,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/8b54346d52c4b3af9893b95b329fe1896e4104fd/src%2Fdrivers%2Fimu%2Fmpu9250%2Fmpu9250.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/8b54346d52c4b3af9893b95b329fe1896e4104fd/src%2Fdrivers%2Fimu%2Fmpu9250%2Fmpu9250.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fdrivers%2Fimu%2Fmpu9250%2Fmpu9250.cpp?ref=8b54346d52c4b3af9893b95b329fe1896e4104fd","patch":"@@ -139,11 +139,7 @@ MPU9250::MPU9250(device::Device *interface, device::Device *mag_interface, const\n \t_gyro_range_scale(0.0f),\n \t_gyro_range_rad_s(0.0f),\n \t_dlpf_freq(MPU9250_DEFAULT_ONCHIP_FILTER_FREQ),\n-#ifdef CONFIG_ARCH_BOARD_CRAZYFLIE\n-\t_sample_rate(200),\n-#else\n \t_sample_rate(1000),\n-#endif\n \t_accel_reads(perf_alloc(PC_COUNT, \"mpu9250_acc_read\")),\n \t_gyro_reads(perf_alloc(PC_COUNT, \"mpu9250_gyro_read\")),\n \t_sample_perf(perf_alloc(PC_ELAPSED, \"mpu9250_read\")),\n@@ -264,6 +260,17 @@ MPU9250::init()\n \tuse_i2c(_interface->ioctl(MPUIOCGIS_I2C, dummy));\n #endif\n \n+\t/*\n+\t * If the MPU is using I2C we should reduce the sample rate to 200Hz and\n+\t * make the integration autoreset faster so that we integrate just one\n+\t * sample since the sampling rate is already low.\n+\t*/\n+\tif (is_i2c()) {\n+\t\t_sample_rate = 200;\n+\t\t_accel_int.set_autoreset_interval(1000000 / MPU9250_ACCEL_MAX_OUTPUT_RATE / 4);\n+\t\t_gyro_int.set_autoreset_interval(1000000 / MPU9250_GYRO_MAX_OUTPUT_RATE / 4);\n+\t}\n+\n \tint ret = probe();\n \n \tif (ret != OK) {"},{"sha":"15f11927aedc086d1cf46f99b536bf39f8b265e4","filename":"src/drivers/imu/mpu9250/mpu9250.h","status":"modified","additions":0,"deletions":4,"changes":4,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/8b54346d52c4b3af9893b95b329fe1896e4104fd/src%2Fdrivers%2Fimu%2Fmpu9250%2Fmpu9250.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/8b54346d52c4b3af9893b95b329fe1896e4104fd/src%2Fdrivers%2Fimu%2Fmpu9250%2Fmpu9250.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fdrivers%2Fimu%2Fmpu9250%2Fmpu9250.h?ref=8b54346d52c4b3af9893b95b329fe1896e4104fd","patch":"@@ -181,11 +181,7 @@\n #define MPU_WHOAMI_6500\t\t\t0x70\n \n #define MPU9250_ACCEL_DEFAULT_RATE\t1000\n-#ifdef CONFIG_ARCH_BOARD_CRAZYFLIE\n-#define MPU9250_ACCEL_MAX_OUTPUT_RATE\t\t\t1000\n-#else\n #define MPU9250_ACCEL_MAX_OUTPUT_RATE\t\t\t280\n-#endif\n #define MPU9250_ACCEL_DEFAULT_DRIVER_FILTER_FREQ 30\n #define MPU9250_GYRO_DEFAULT_RATE\t1000\n /* rates need to be the same between accel and gyro */"},{"sha":"30ef7a4f92a5b52a3c50a23f57ba06be3f6ffbf3","filename":"src/lib/drivers/device/integrator.h","status":"modified","additions":13,"deletions":1,"changes":14,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/8b54346d52c4b3af9893b95b329fe1896e4104fd/src%2Flib%2Fdrivers%2Fdevice%2Fintegrator.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/8b54346d52c4b3af9893b95b329fe1896e4104fd/src%2Flib%2Fdrivers%2Fdevice%2Fintegrator.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Flib%2Fdrivers%2Fdevice%2Fintegrator.h?ref=8b54346d52c4b3af9893b95b329fe1896e4104fd","patch":"@@ -1,6 +1,6 @@\n /****************************************************************************\n  *\n- *   Copyright (c) 2015-2016 PX4 Development Team. All rights reserved.\n+ *   Copyright (c) 2015-2018 PX4 Development Team. All rights reserved.\n  *\n  * Redistribution and use in source and binary forms, with or without\n  * modification, are permitted provided that the following conditions\n@@ -86,6 +86,7 @@ class Integrator\n \t */\n \tmatrix::Vector3f\tget(bool reset, uint64_t &integral_dt);\n \n+\n \t/**\n \t * Get the current integral and reset the integrator if needed. Additionally give the\n \t * integral over the samples differentiated by the integration time (mean filtered values).\n@@ -97,6 +98,17 @@ class Integrator\n \t */\n \tmatrix::Vector3f\tget_and_filtered(bool reset, uint64_t &integral_dt, matrix::Vector3f &filtered_val);\n \n+\n+\t/**\n+\t * Set auto reset interval during runtime. This won't reset the integrator.\n+\t *\n+\t * @param auto_reset_interval\t    \tNew reset time interval for the integrator.\n+\t */\n+\tvoid set_autoreset_interval(uint64_t auto_reset_interval)\n+\t{\n+\t\t_auto_reset_interval = auto_reset_interval;\n+\t}\n+\n private:\n \tuint64_t _auto_reset_interval;\t\t\t/**< the interval after which the content will be published\n \t\t\t\t\t\t\t     and the integrator reset, 0 if no auto-reset */"}]}