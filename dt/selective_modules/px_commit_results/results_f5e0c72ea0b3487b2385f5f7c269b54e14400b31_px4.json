{"sha":"f5e0c72ea0b3487b2385f5f7c269b54e14400b31","node_id":"MDY6Q29tbWl0NTI5ODc5MDpmNWUwYzcyZWEwYjM0ODdiMjM4NWY1ZjdjMjY5YjU0ZTE0NDAwYjMx","commit":{"author":{"name":"Julian Oes","email":"julian@oes.ch","date":"2016-02-22T11:41:13Z"},"committer":{"name":"tumbili","email":"bapstr@ethz.ch","date":"2016-03-14T08:45:34Z"},"message":"FixedwingLandDetector: timeout fixes\n\nIn the case of the control state topic not updating, the land detector\nwould get stuck. Therefore, set it to landed in that case.","tree":{"sha":"8a891d1fb1b1fbfbb3ab1cc45ba10f14f98a2381","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/8a891d1fb1b1fbfbb3ab1cc45ba10f14f98a2381"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/f5e0c72ea0b3487b2385f5f7c269b54e14400b31","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/f5e0c72ea0b3487b2385f5f7c269b54e14400b31","html_url":"https://github.com/PX4/PX4-Autopilot/commit/f5e0c72ea0b3487b2385f5f7c269b54e14400b31","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/f5e0c72ea0b3487b2385f5f7c269b54e14400b31/comments","author":{"login":"julianoes","id":1419688,"node_id":"MDQ6VXNlcjE0MTk2ODg=","avatar_url":"https://avatars.githubusercontent.com/u/1419688?v=4","gravatar_id":"","url":"https://api.github.com/users/julianoes","html_url":"https://github.com/julianoes","followers_url":"https://api.github.com/users/julianoes/followers","following_url":"https://api.github.com/users/julianoes/following{/other_user}","gists_url":"https://api.github.com/users/julianoes/gists{/gist_id}","starred_url":"https://api.github.com/users/julianoes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/julianoes/subscriptions","organizations_url":"https://api.github.com/users/julianoes/orgs","repos_url":"https://api.github.com/users/julianoes/repos","events_url":"https://api.github.com/users/julianoes/events{/privacy}","received_events_url":"https://api.github.com/users/julianoes/received_events","type":"User","site_admin":false},"committer":{"login":"RomanBapst","id":7610489,"node_id":"MDQ6VXNlcjc2MTA0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/7610489?v=4","gravatar_id":"","url":"https://api.github.com/users/RomanBapst","html_url":"https://github.com/RomanBapst","followers_url":"https://api.github.com/users/RomanBapst/followers","following_url":"https://api.github.com/users/RomanBapst/following{/other_user}","gists_url":"https://api.github.com/users/RomanBapst/gists{/gist_id}","starred_url":"https://api.github.com/users/RomanBapst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RomanBapst/subscriptions","organizations_url":"https://api.github.com/users/RomanBapst/orgs","repos_url":"https://api.github.com/users/RomanBapst/repos","events_url":"https://api.github.com/users/RomanBapst/events{/privacy}","received_events_url":"https://api.github.com/users/RomanBapst/received_events","type":"User","site_admin":false},"parents":[{"sha":"0cab41075b2c3e7cfca578b6f4f74b26a5765dbb","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/0cab41075b2c3e7cfca578b6f4f74b26a5765dbb","html_url":"https://github.com/PX4/PX4-Autopilot/commit/0cab41075b2c3e7cfca578b6f4f74b26a5765dbb"}],"stats":{"total":28,"additions":15,"deletions":13},"files":[{"sha":"59b9b7230e65e6cbb7333e701e3ec60c3ee922be","filename":"src/modules/land_detector/FixedwingLandDetector.cpp","status":"modified","additions":15,"deletions":13,"changes":28,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/f5e0c72ea0b3487b2385f5f7c269b54e14400b31/src%2Fmodules%2Fland_detector%2FFixedwingLandDetector.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/f5e0c72ea0b3487b2385f5f7c269b54e14400b31/src%2Fmodules%2Fland_detector%2FFixedwingLandDetector.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fland_detector%2FFixedwingLandDetector.cpp?ref=f5e0c72ea0b3487b2385f5f7c269b54e14400b31","patch":"@@ -1,6 +1,6 @@\n /****************************************************************************\n  *\n- *   Copyright (c) 2013-2015 PX4 Development Team. All rights reserved.\n+ *   Copyright (c) 2013-2016 PX4 Development Team. All rights reserved.\n  *\n  * Redistribution and use in source and binary forms, with or without\n  * modification, are permitted provided that the following conditions\n@@ -72,7 +72,6 @@ FixedwingLandDetector::FixedwingLandDetector() : LandDetector(),\n \n void FixedwingLandDetector::initialize()\n {\n-\t// Subscribe to local position and airspeed data\n \t_controlStateSub = orb_subscribe(ORB_ID(control_state));\n \t_vehicleStatusSub = orb_subscribe(ORB_ID(vehicle_status));\n \t_armingSub = orb_subscribe(ORB_ID(actuator_armed));\n@@ -122,22 +121,25 @@ bool FixedwingLandDetector::update()\n \t\t// gives a mostly correct response for short impulses\n \t\t_accel_horz_lp = _accel_horz_lp * 0.8f + _controlState.horz_acc_mag * 0.18f;\n \n-\t}\n+\t\t// crude land detector for fixedwing\n+\t\tif (_velocity_xy_filtered < _params.maxVelocity\n+\t\t    && _velocity_z_filtered < _params.maxClimbRate\n+\t\t    && _airspeed_filtered < _params.maxAirSpeed\n+\t\t    && _accel_horz_lp < _params.maxIntVelocity) {\n \n-\t// crude land detector for fixedwing\n-\tif (_velocity_xy_filtered < _params.maxVelocity\n-\t    && _velocity_z_filtered < _params.maxClimbRate\n-\t    && _airspeed_filtered < _params.maxAirSpeed\n-\t    && _accel_horz_lp < _params.maxIntVelocity) {\n+\t\t\t// these conditions need to be stable for a period of time before we trust them\n+\t\t\tif (now > _landDetectTrigger) {\n+\t\t\t\tlandDetected = true;\n+\t\t\t}\n \n-\t\t// these conditions need to be stable for a period of time before we trust them\n-\t\tif (now > _landDetectTrigger) {\n-\t\t\tlandDetected = true;\n+\t\t} else {\n+\t\t\t// reset land detect trigger\n+\t\t\t_landDetectTrigger = now + LAND_DETECTOR_TRIGGER_TIME;\n \t\t}\n \n \t} else {\n-\t\t// reset land detect trigger\n-\t\t_landDetectTrigger = now + LAND_DETECTOR_TRIGGER_TIME;\n+\t\t// Control state topic has timed out and we need to assume we're landed.\n+\t\tlandDetected = true;\n \t}\n \n \treturn landDetected;"}]}