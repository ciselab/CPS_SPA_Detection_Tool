{"sha":"496127ca459c603e5de3f8bc83c6113bcf9cbead","node_id":"MDY6Q29tbWl0NTI5ODc5MDo0OTYxMjdjYTQ1OWM2MDNlNWRlM2Y4YmM4M2M2MTEzYmNmOWNiZWFk","commit":{"author":{"name":"sergeil","email":"vectra14@gmail.com","date":"2013-05-31T09:44:20Z"},"committer":{"name":"sergeil","email":"vectra14@gmail.com","date":"2013-05-31T09:44:20Z"},"message":"mpu6000 driver support for setting rate","tree":{"sha":"1fce7d54431a06861d95a19450fa0d84b4e82e0d","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/1fce7d54431a06861d95a19450fa0d84b4e82e0d"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/496127ca459c603e5de3f8bc83c6113bcf9cbead","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/496127ca459c603e5de3f8bc83c6113bcf9cbead","html_url":"https://github.com/PX4/PX4-Autopilot/commit/496127ca459c603e5de3f8bc83c6113bcf9cbead","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/496127ca459c603e5de3f8bc83c6113bcf9cbead/comments","author":{"login":"fibr","id":3940694,"node_id":"MDQ6VXNlcjM5NDA2OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/3940694?v=4","gravatar_id":"","url":"https://api.github.com/users/fibr","html_url":"https://github.com/fibr","followers_url":"https://api.github.com/users/fibr/followers","following_url":"https://api.github.com/users/fibr/following{/other_user}","gists_url":"https://api.github.com/users/fibr/gists{/gist_id}","starred_url":"https://api.github.com/users/fibr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fibr/subscriptions","organizations_url":"https://api.github.com/users/fibr/orgs","repos_url":"https://api.github.com/users/fibr/repos","events_url":"https://api.github.com/users/fibr/events{/privacy}","received_events_url":"https://api.github.com/users/fibr/received_events","type":"User","site_admin":false},"committer":{"login":"fibr","id":3940694,"node_id":"MDQ6VXNlcjM5NDA2OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/3940694?v=4","gravatar_id":"","url":"https://api.github.com/users/fibr","html_url":"https://github.com/fibr","followers_url":"https://api.github.com/users/fibr/followers","following_url":"https://api.github.com/users/fibr/following{/other_user}","gists_url":"https://api.github.com/users/fibr/gists{/gist_id}","starred_url":"https://api.github.com/users/fibr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fibr/subscriptions","organizations_url":"https://api.github.com/users/fibr/orgs","repos_url":"https://api.github.com/users/fibr/repos","events_url":"https://api.github.com/users/fibr/events{/privacy}","received_events_url":"https://api.github.com/users/fibr/received_events","type":"User","site_admin":false},"parents":[{"sha":"27ee36b2049167a1272122548fe61aa2993d79c1","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/27ee36b2049167a1272122548fe61aa2993d79c1","html_url":"https://github.com/PX4/PX4-Autopilot/commit/27ee36b2049167a1272122548fe61aa2993d79c1"}],"stats":{"total":30,"additions":24,"deletions":6},"files":[{"sha":"2208425369a8f3c814e0644b0b51856c6bc6630f","filename":"src/drivers/mpu6000/mpu6000.cpp","status":"modified","additions":24,"deletions":6,"changes":30,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/496127ca459c603e5de3f8bc83c6113bcf9cbead/src%2Fdrivers%2Fmpu6000%2Fmpu6000.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/496127ca459c603e5de3f8bc83c6113bcf9cbead/src%2Fdrivers%2Fmpu6000%2Fmpu6000.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fdrivers%2Fmpu6000%2Fmpu6000.cpp?ref=496127ca459c603e5de3f8bc83c6113bcf9cbead","patch":"@@ -1,6 +1,6 @@\n /****************************************************************************\n  *\n- *   Copyright (c) 2012, 2013 PX4 Development Team. All rights reserved.\n+ *   Copyright (C) 2012 PX4 Development Team. All rights reserved.\n  *\n  * Redistribution and use in source and binary forms, with or without\n  * modification, are permitted provided that the following conditions\n@@ -272,6 +272,11 @@ class MPU6000 : public device::SPI\n \t */\n \tvoid _set_dlpf_filter(uint16_t frequency_hz);\n \n+\t/*\n+\t  set sample rate (approximate) - 1kHz to 5Hz\n+\t*/\n+\tvoid _set_sample_rate(uint16_t desired_sample_rate_hz);\n+\n };\n \n /**\n@@ -378,7 +383,8 @@ MPU6000::init()\n \tup_udelay(1000);\n \n \t// SAMPLE RATE\n-\twrite_reg(MPUREG_SMPLRT_DIV, 0x04);     // Sample rate = 200Hz    Fsample= 1Khz/(4+1) = 200Hz\n+\t//write_reg(MPUREG_SMPLRT_DIV, 0x04);     // Sample rate = 200Hz    Fsample= 1Khz/(4+1) = 200Hz\n+\t_set_sample_rate(200); // default sample rate = 200Hz\n \tusleep(1000);\n \n \t// FS & DLPF   FS=2000 deg/s, DLPF = 20Hz (low pass filter)\n@@ -493,6 +499,18 @@ MPU6000::probe()\n \treturn -EIO;\n }\n \n+/*\n+  set sample rate (approximate) - 1kHz to 5Hz, for both accel and gyro\n+*/\n+void\n+MPU6000::_set_sample_rate(uint16_t desired_sample_rate_hz)\n+{\n+  uint8_t div = 1000 / desired_sample_rate_hz;\n+  if(div>200) div=200;\n+  if(div<1) div=1;\n+  write_reg(MPUREG_SMPLRT_DIV, div-1);\n+}\n+\n /*\n   set the DLPF filter frequency. This affects both accel and gyro.\n  */\n@@ -644,8 +662,8 @@ MPU6000::ioctl(struct file *filp, int cmd, unsigned long arg)\n \n \tcase ACCELIOCSSAMPLERATE:\n \tcase ACCELIOCGSAMPLERATE:\n-\t\t/* XXX not implemented */\n-\t\treturn -EINVAL;\n+\t  _set_sample_rate(arg);\n+\t  return OK;\n \n \tcase ACCELIOCSLOWPASS:\n \tcase ACCELIOCGLOWPASS:\n@@ -702,8 +720,8 @@ MPU6000::gyro_ioctl(struct file *filp, int cmd, unsigned long arg)\n \n \tcase GYROIOCSSAMPLERATE:\n \tcase GYROIOCGSAMPLERATE:\n-\t\t/* XXX not implemented */\n-\t\treturn -EINVAL;\n+\t  _set_sample_rate(arg);\n+\t  return OK;\n \n \tcase GYROIOCSLOWPASS:\n \tcase GYROIOCGLOWPASS:"}]}