{"sha":"6948defdb26711fd8336b5e0173664bf98517406","node_id":"MDY6Q29tbWl0NTI5ODc5MDo2OTQ4ZGVmZGIyNjcxMWZkODMzNmI1ZTAxNzM2NjRiZjk4NTE3NDA2","commit":{"author":{"name":"Anton Babushkin","email":"anton.babushkin@me.com","date":"2014-03-01T15:27:53Z"},"committer":{"name":"Anton Babushkin","email":"anton.babushkin@me.com","date":"2014-03-01T15:27:53Z"},"message":"mavlink: HIL fixes, performance optimization","tree":{"sha":"979a3703bc2a0fb2b68f7f66c349f17c79161334","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/979a3703bc2a0fb2b68f7f66c349f17c79161334"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/6948defdb26711fd8336b5e0173664bf98517406","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/6948defdb26711fd8336b5e0173664bf98517406","html_url":"https://github.com/PX4/PX4-Autopilot/commit/6948defdb26711fd8336b5e0173664bf98517406","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/6948defdb26711fd8336b5e0173664bf98517406/comments","author":{"login":"DrTon","id":4341525,"node_id":"MDQ6VXNlcjQzNDE1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4341525?v=4","gravatar_id":"","url":"https://api.github.com/users/DrTon","html_url":"https://github.com/DrTon","followers_url":"https://api.github.com/users/DrTon/followers","following_url":"https://api.github.com/users/DrTon/following{/other_user}","gists_url":"https://api.github.com/users/DrTon/gists{/gist_id}","starred_url":"https://api.github.com/users/DrTon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DrTon/subscriptions","organizations_url":"https://api.github.com/users/DrTon/orgs","repos_url":"https://api.github.com/users/DrTon/repos","events_url":"https://api.github.com/users/DrTon/events{/privacy}","received_events_url":"https://api.github.com/users/DrTon/received_events","type":"User","site_admin":false},"committer":{"login":"DrTon","id":4341525,"node_id":"MDQ6VXNlcjQzNDE1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4341525?v=4","gravatar_id":"","url":"https://api.github.com/users/DrTon","html_url":"https://github.com/DrTon","followers_url":"https://api.github.com/users/DrTon/followers","following_url":"https://api.github.com/users/DrTon/following{/other_user}","gists_url":"https://api.github.com/users/DrTon/gists{/gist_id}","starred_url":"https://api.github.com/users/DrTon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DrTon/subscriptions","organizations_url":"https://api.github.com/users/DrTon/orgs","repos_url":"https://api.github.com/users/DrTon/repos","events_url":"https://api.github.com/users/DrTon/events{/privacy}","received_events_url":"https://api.github.com/users/DrTon/received_events","type":"User","site_admin":false},"parents":[{"sha":"256cc2b411b1f36397884bfd019b9ac3e4cd1850","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/256cc2b411b1f36397884bfd019b9ac3e4cd1850","html_url":"https://github.com/PX4/PX4-Autopilot/commit/256cc2b411b1f36397884bfd019b9ac3e4cd1850"}],"stats":{"total":29,"additions":18,"deletions":11},"files":[{"sha":"0de2d429584c427d8deccebcf0ecb32f73eed997","filename":"ROMFS/px4fmu_common/init.d/rc.usb","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/6948defdb26711fd8336b5e0173664bf98517406/ROMFS%2Fpx4fmu_common%2Finit.d%2Frc.usb","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/6948defdb26711fd8336b5e0173664bf98517406/ROMFS%2Fpx4fmu_common%2Finit.d%2Frc.usb","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/ROMFS%2Fpx4fmu_common%2Finit.d%2Frc.usb?ref=6948defdb26711fd8336b5e0173664bf98517406","patch":"@@ -5,7 +5,7 @@\n \n echo \"Starting MAVLink on this USB console\"\n \n-mavlink start -r 10000 -d /dev/ttyACM0\n+mavlink start -r 5000 -d /dev/ttyACM0\n \n # Exit shell to make it available to MAVLink\n exit "},{"sha":"48532e7af6ec792da7ef1a2c7dea2099367bebd8","filename":"ROMFS/px4fmu_common/init.d/rcS","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/6948defdb26711fd8336b5e0173664bf98517406/ROMFS%2Fpx4fmu_common%2Finit.d%2FrcS","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/6948defdb26711fd8336b5e0173664bf98517406/ROMFS%2Fpx4fmu_common%2Finit.d%2FrcS","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/ROMFS%2Fpx4fmu_common%2Finit.d%2FrcS?ref=6948defdb26711fd8336b5e0173664bf98517406","patch":"@@ -387,7 +387,7 @@ then\n \t\tif [ $HIL == yes ]\n \t\tthen\n \t\t\tsleep 1\n-\t\t\tset MAVLINK_FLAGS \"-d 10000 -d /dev/ttyACM0\"\n+\t\t\tset MAVLINK_FLAGS \"-r 10000 -d /dev/ttyACM0 -m hil\"\n \t\t\tusleep 5000\n \t\telse\n \t\t\t# Normal mode, use baudrate 57600 (default) and data rate 1000 bytes/s"},{"sha":"fb29c9c716547972e327763bd0e5fc56e4d2df79","filename":"src/modules/mavlink/mavlink_main.cpp","status":"modified","additions":13,"deletions":8,"changes":21,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/6948defdb26711fd8336b5e0173664bf98517406/src%2Fmodules%2Fmavlink%2Fmavlink_main.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/6948defdb26711fd8336b5e0173664bf98517406/src%2Fmodules%2Fmavlink%2Fmavlink_main.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fmavlink%2Fmavlink_main.cpp?ref=6948defdb26711fd8336b5e0173664bf98517406","patch":"@@ -90,7 +90,7 @@ static const int ERROR = -1;\n \n #define DEFAULT_DEVICE_NAME\t\"/dev/ttyS1\"\n #define MAX_DATA_RATE\t10000\t// max data rate in bytes/s\n-#define MAIN_LOOP_DELAY 10000\t// 100 Hz\n+#define MAIN_LOOP_DELAY 10000\t// 100 Hz @ 1000 bytes/s data rate\n \n static Mavlink *_mavlink_instances = nullptr;\n \n@@ -166,6 +166,7 @@ Mavlink::Mavlink() :\n \t_mavlink_fd(-1),\n \t_task_running(false),\n \t_mavlink_hil_enabled(false),\n+\t_main_loop_delay(1000),\n \t_subscriptions(nullptr),\n \t_streams(nullptr),\n \t_mission_pub(-1),\n@@ -1723,7 +1724,7 @@ Mavlink::task_main(int argc, char *argv[])\n \tswitch (_mode) {\n \tcase MODE_OFFBOARD:\n \t\tconfigure_stream(\"SYS_STATUS\", 1.0f);\n-\t\tconfigure_stream(\"GPS_GLOBAL_ORIGIN\", 0.5f * rate_mult);\n+\t\tconfigure_stream(\"GPS_GLOBAL_ORIGIN\", 0.5f);\n \t\tconfigure_stream(\"HIGHRES_IMU\", 1.0f * rate_mult);\n \t\tconfigure_stream(\"ATTITUDE\", 10.0f * rate_mult);\n \t\tconfigure_stream(\"GPS_RAW_INT\", 1.0f * rate_mult);\n@@ -1733,14 +1734,15 @@ Mavlink::task_main(int argc, char *argv[])\n \t\tbreak;\n \n \tcase MODE_HIL:\n+\t\t/* HIL mode normally runs at high data rate, rate_mult ~ 10 */\n \t\tconfigure_stream(\"SYS_STATUS\", 1.0f);\n-\t\tconfigure_stream(\"GPS_GLOBAL_ORIGIN\", 0.5f * rate_mult);\n+\t\tconfigure_stream(\"GPS_GLOBAL_ORIGIN\", 0.5f);\n \t\tconfigure_stream(\"HIGHRES_IMU\", 1.0f * rate_mult);\n-\t\tconfigure_stream(\"ATTITUDE\", 10.0f * rate_mult);\n+\t\tconfigure_stream(\"ATTITUDE\", 2.0f * rate_mult);\n \t\tconfigure_stream(\"GPS_RAW_INT\", 1.0f * rate_mult);\n-\t\tconfigure_stream(\"GLOBAL_POSITION_INT\", 5.0f * rate_mult);\n-\t\tconfigure_stream(\"LOCAL_POSITION_NED\", 5.0f * rate_mult);\n-\t\tconfigure_stream(\"HIL_CONTROLS\", 20.0f * rate_mult);\n+\t\tconfigure_stream(\"GLOBAL_POSITION_INT\", 1.0f * rate_mult);\n+\t\tconfigure_stream(\"LOCAL_POSITION_NED\", 1.0f * rate_mult);\n+\t\tconfigure_stream(\"HIL_CONTROLS\", 15.0f * rate_mult);\n \t\tbreak;\n \n \tdefault:\n@@ -1753,9 +1755,12 @@ Mavlink::task_main(int argc, char *argv[])\n \tMavlinkRateLimiter slow_rate_limiter(2000.0f / rate_mult);\n \tMavlinkRateLimiter fast_rate_limiter(100.0f / rate_mult);\n \n+\t/* set main loop delay depending on data rate to minimize CPU overhead */\n+\t_main_loop_delay = MAIN_LOOP_DELAY / rate_mult;\n+\n \twhile (!_task_should_exit) {\n \t\t/* main loop */\n-\t\tusleep(MAIN_LOOP_DELAY);\n+\t\tusleep(_main_loop_delay);\n \n \t\tperf_begin(_loop_perf);\n "},{"sha":"b52c12796d84ed0d046a09b55432d263127511b0","filename":"src/modules/mavlink/mavlink_main.h","status":"modified","additions":3,"deletions":1,"changes":4,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/6948defdb26711fd8336b5e0173664bf98517406/src%2Fmodules%2Fmavlink%2Fmavlink_main.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/6948defdb26711fd8336b5e0173664bf98517406/src%2Fmodules%2Fmavlink%2Fmavlink_main.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fmavlink%2Fmavlink_main.h?ref=6948defdb26711fd8336b5e0173664bf98517406","patch":"@@ -196,7 +196,9 @@ class Mavlink\n \tperf_counter_t\t_loop_perf;\t\t\t/**< loop performance counter */\n \n \t/* states */\n-\tbool\t\t_mavlink_hil_enabled;\t\t/**< Hardware in the loop mode */\n+\tbool\t\t_mavlink_hil_enabled;\t\t/**< Hardware In the Loop mode */\n+\n+\tunsigned\t_main_loop_delay;\t\t/**< mainloop delay, depends on data rate */\n \n \tMavlinkOrbSubscription *_subscriptions;\n \tMavlinkStream *_streams;"}]}