{"sha":"fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a","node_id":"MDY6Q29tbWl0NTI5ODc5MDpmYzMwZjI5MDZmZDhiOGRjNWZlNTJjMzhhODg3ZTllNGU1NmIyZTBh","commit":{"author":{"name":"David Sidrane","email":"david_s5@nscdg.com","date":"2017-07-11T01:45:29Z"},"committer":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2017-07-11T07:51:31Z"},"message":"mpu9250:Use a cpu speed independant _reset_wait generations.\n\n   This change first pushes out the _reset_wait by 100 Ms.\n   which is about 3 time longer then the code take to execute.\n\n   Then it does the reset of the accel, gyro and mag and\n   the ends the wait by setting _reset_wait to now+10 us.","tree":{"sha":"2241af043656152d6cfcf0cd02dddb0b0e333f96","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/2241af043656152d6cfcf0cd02dddb0b0e333f96"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a","html_url":"https://github.com/PX4/PX4-Autopilot/commit/fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a/comments","author":null,"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"3f0d26c94938a10788097a264a6c2b4b86012434","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/3f0d26c94938a10788097a264a6c2b4b86012434","html_url":"https://github.com/PX4/PX4-Autopilot/commit/3f0d26c94938a10788097a264a6c2b4b86012434"}],"stats":{"total":21,"additions":12,"deletions":9},"files":[{"sha":"5931daf5bdd8ccbfca55b22df2739311a4ffe84c","filename":"src/drivers/mpu9250/mpu9250.cpp","status":"modified","additions":12,"deletions":9,"changes":21,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a/src%2Fdrivers%2Fmpu9250%2Fmpu9250.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a/src%2Fdrivers%2Fmpu9250%2Fmpu9250.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fdrivers%2Fmpu9250%2Fmpu9250.cpp?ref=fc30f2906fd8b8dc5fe52c38a887e9e4e56b2e0a","patch":"@@ -375,9 +375,9 @@ int MPU9250::reset()\n {\n \tirqstate_t state;\n \n-\t// Hold off sampling for 4 ms\n+\t// Hold off sampling until done (100 MS will be shortened)\n \tstate = px4_enter_critical_section();\n-\t_reset_wait = hrt_absolute_time() + 10000;\n+\t_reset_wait = hrt_absolute_time() + 100000;\n \n \twrite_reg(MPUREG_PWR_MGMT_1, BIT_H_RESET);\n \n@@ -453,6 +453,15 @@ int MPU9250::reset()\n \t\t}\n \t}\n \n+\n+\tif (all_ok && _whoami == MPU_WHOAMI_9250) {\n+\t\tall_ok = _mag->ak8963_reset() == OK;\n+\t}\n+\n+\tstate = px4_enter_critical_section();\n+\t_reset_wait = hrt_absolute_time() + 10;\n+\tpx4_leave_critical_section(state);\n+\n \treturn all_ok ? OK : -EIO;\n }\n \n@@ -721,13 +730,7 @@ MPU9250::ioctl(struct file *filp, int cmd, unsigned long arg)\n \tswitch (cmd) {\n \n \tcase SENSORIOCRESET: {\n-\t\t\tint ret = reset();\n-\n-\t\t\tif (_whoami == MPU_WHOAMI_9250) {\n-\t\t\t\treturn (ret == OK ? _mag->ioctl(filp, cmd, arg) : ret);\n-\t\t\t}\n-\n-\t\t\treturn ret;\n+\t\t\treturn reset();\n \t\t}\n \n \tcase SENSORIOCSPOLLRATE: {"}]}