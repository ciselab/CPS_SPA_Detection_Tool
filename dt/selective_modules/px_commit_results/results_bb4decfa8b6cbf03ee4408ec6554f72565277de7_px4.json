{"sha":"bb4decfa8b6cbf03ee4408ec6554f72565277de7","node_id":"MDY6Q29tbWl0NTI5ODc5MDpiYjRkZWNmYThiNmNiZjAzZWU0NDA4ZWM2NTU0ZjcyNTY1Mjc3ZGU3","commit":{"author":{"name":"Andreas Antener","email":"antener_a@gmx.ch","date":"2016-02-12T12:55:16Z"},"committer":{"name":"Andreas Antener","email":"antener_a@gmx.ch","date":"2016-02-15T22:26:28Z"},"message":"implemented basic heading timeout for waypoint acceptance, added parameter for yaw error on waypoint heading acceptance, set yaw timeout for vtol default","tree":{"sha":"733e9370f2afeba5ab5f3a0c6cbf8730a82648d7","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/733e9370f2afeba5ab5f3a0c6cbf8730a82648d7"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/bb4decfa8b6cbf03ee4408ec6554f72565277de7","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/bb4decfa8b6cbf03ee4408ec6554f72565277de7","html_url":"https://github.com/PX4/PX4-Autopilot/commit/bb4decfa8b6cbf03ee4408ec6554f72565277de7","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/bb4decfa8b6cbf03ee4408ec6554f72565277de7/comments","author":{"login":"AndreasAntener","id":5750020,"node_id":"MDQ6VXNlcjU3NTAwMjA=","avatar_url":"https://avatars.githubusercontent.com/u/5750020?v=4","gravatar_id":"","url":"https://api.github.com/users/AndreasAntener","html_url":"https://github.com/AndreasAntener","followers_url":"https://api.github.com/users/AndreasAntener/followers","following_url":"https://api.github.com/users/AndreasAntener/following{/other_user}","gists_url":"https://api.github.com/users/AndreasAntener/gists{/gist_id}","starred_url":"https://api.github.com/users/AndreasAntener/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndreasAntener/subscriptions","organizations_url":"https://api.github.com/users/AndreasAntener/orgs","repos_url":"https://api.github.com/users/AndreasAntener/repos","events_url":"https://api.github.com/users/AndreasAntener/events{/privacy}","received_events_url":"https://api.github.com/users/AndreasAntener/received_events","type":"User","site_admin":false},"committer":{"login":"AndreasAntener","id":5750020,"node_id":"MDQ6VXNlcjU3NTAwMjA=","avatar_url":"https://avatars.githubusercontent.com/u/5750020?v=4","gravatar_id":"","url":"https://api.github.com/users/AndreasAntener","html_url":"https://github.com/AndreasAntener","followers_url":"https://api.github.com/users/AndreasAntener/followers","following_url":"https://api.github.com/users/AndreasAntener/following{/other_user}","gists_url":"https://api.github.com/users/AndreasAntener/gists{/gist_id}","starred_url":"https://api.github.com/users/AndreasAntener/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndreasAntener/subscriptions","organizations_url":"https://api.github.com/users/AndreasAntener/orgs","repos_url":"https://api.github.com/users/AndreasAntener/repos","events_url":"https://api.github.com/users/AndreasAntener/events{/privacy}","received_events_url":"https://api.github.com/users/AndreasAntener/received_events","type":"User","site_admin":false},"parents":[{"sha":"0a4d0f6eaed8e0a79054a3236d83479d34dc7630","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/0a4d0f6eaed8e0a79054a3236d83479d34dc7630","html_url":"https://github.com/PX4/PX4-Autopilot/commit/0a4d0f6eaed8e0a79054a3236d83479d34dc7630"}],"stats":{"total":45,"additions":41,"deletions":4},"files":[{"sha":"8d076ff5cdad091584606a3bd688eadd1733a545","filename":"ROMFS/px4fmu_common/init.d/rc.vtol_defaults","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bb4decfa8b6cbf03ee4408ec6554f72565277de7/ROMFS%2Fpx4fmu_common%2Finit.d%2Frc.vtol_defaults","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bb4decfa8b6cbf03ee4408ec6554f72565277de7/ROMFS%2Fpx4fmu_common%2Finit.d%2Frc.vtol_defaults","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/ROMFS%2Fpx4fmu_common%2Finit.d%2Frc.vtol_defaults?ref=bb4decfa8b6cbf03ee4408ec6554f72565277de7","patch":"@@ -47,6 +47,7 @@ then\n \tparam set MPC_LAND_SPEED 0.7\n \tparam set MPC_Z_VEL_MAX 1.5\n \tparam set MPC_XY_VEL_MAX 4.0\n+\tparam set MIS_YAW_TMT 10\n fi\n \n set PWM_DISARMED 900"},{"sha":"2fcf01e12dcbac15f39d855fbc8cf6684cc0cb46","filename":"posix-configs/SITL/init/rcS_gazebo_standard_vtol","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bb4decfa8b6cbf03ee4408ec6554f72565277de7/posix-configs%2FSITL%2Finit%2FrcS_gazebo_standard_vtol","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bb4decfa8b6cbf03ee4408ec6554f72565277de7/posix-configs%2FSITL%2Finit%2FrcS_gazebo_standard_vtol","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/posix-configs%2FSITL%2Finit%2FrcS_gazebo_standard_vtol?ref=bb4decfa8b6cbf03ee4408ec6554f72565277de7","patch":"@@ -32,6 +32,7 @@ param set SENS_BOARD_ROT 8\n param set COM_RC_IN_MODE 1\n param set NAV_ACC_RAD 3.0\n param set MPC_TKO_SPEED 1.0\n+param set MIS_YAW_TMT 5\n rgbledsim start\n tone_alarm start\n gyrosim start"},{"sha":"1b33f4b4386a7a9c3ac6fd02273983eb0918b7a6","filename":"src/modules/navigator/mission_block.cpp","status":"modified","additions":13,"deletions":1,"changes":14,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bb4decfa8b6cbf03ee4408ec6554f72565277de7/src%2Fmodules%2Fnavigator%2Fmission_block.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bb4decfa8b6cbf03ee4408ec6554f72565277de7/src%2Fmodules%2Fnavigator%2Fmission_block.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fnavigator%2Fmission_block.cpp?ref=bb4decfa8b6cbf03ee4408ec6554f72565277de7","patch":"@@ -49,6 +49,7 @@\n #include <systemlib/err.h>\n #include <geo/geo.h>\n #include <mavlink/mavlink_log.h>\n+#include <mathlib/mathlib.h>\n \n #include <uORB/uORB.h>\n #include <uORB/topics/actuator_controls.h>\n@@ -68,9 +69,12 @@ MissionBlock::MissionBlock(Navigator *navigator, const char *name) :\n \t_waypoint_yaw_reached(false),\n \t_time_first_inside_orbit(0),\n \t_action_start(0),\n+\t_time_wp_reached(0),\n \t_actuators{},\n \t_actuator_pub(nullptr),\n \t_cmd_pub(nullptr),\n+\t_param_yaw_timeout(this, \"MIS_YAW_TMT\", false),\n+\t_param_yaw_err(this, \"MIS_YAW_ERR\", false),\n \t_param_vtol_wv_land(this, \"VT_WV_LND_EN\", false),\n \t_param_vtol_wv_loiter(this, \"VT_WV_LTR_EN\", false)\n {\n@@ -174,6 +178,11 @@ MissionBlock::is_mission_item_reached()\n \t\t\t\t_waypoint_position_reached = true;\n \t\t\t}\n \t\t}\n+\n+\t\tif (_waypoint_position_reached) {\n+\t\t\t// reached just now\n+\t\t\t_time_wp_reached = now;\n+\t\t}\n \t}\n \n \t/* Check if the waypoint and the requested yaw setpoint. */\n@@ -186,7 +195,9 @@ MissionBlock::is_mission_item_reached()\n \t\t\t/* check yaw if defined only for rotary wing except takeoff */\n \t\t\tfloat yaw_err = _wrap_pi(_mission_item.yaw - _navigator->get_global_position()->yaw);\n \n-\t\t\tif (fabsf(yaw_err) < 0.2f) { /* TODO: get rid of magic number */\n+\t\t\tif (fabsf(yaw_err) < math::radians(_param_yaw_err.get())\n+\t\t\t\t\t|| (_param_yaw_timeout.get() >= -FLT_EPSILON &&\n+\t\t\t\t\t\tnow - _time_wp_reached >= (hrt_abstime)_param_yaw_timeout.get() * 1e6f)) {\n \t\t\t\t_waypoint_yaw_reached = true;\n \t\t\t}\n \n@@ -221,6 +232,7 @@ MissionBlock::reset_mission_item_reached()\n \t_waypoint_position_reached = false;\n \t_waypoint_yaw_reached = false;\n \t_time_first_inside_orbit = 0;\n+\t_time_wp_reached = 0;\n }\n \n void"},{"sha":"2f69294d1f0d1d8efc51d2ce513c6610981ce642","filename":"src/modules/navigator/mission_block.h","status":"modified","additions":4,"deletions":3,"changes":7,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bb4decfa8b6cbf03ee4408ec6554f72565277de7/src%2Fmodules%2Fnavigator%2Fmission_block.h","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bb4decfa8b6cbf03ee4408ec6554f72565277de7/src%2Fmodules%2Fnavigator%2Fmission_block.h","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fnavigator%2Fmission_block.h?ref=bb4decfa8b6cbf03ee4408ec6554f72565277de7","patch":"@@ -45,9 +45,6 @@\n \n #include <navigator/navigation.h>\n \n-#include <controllib/blocks.hpp>\n-#include <controllib/block/BlockParam.hpp>\n-\n #include <uORB/topics/mission.h>\n #include <uORB/topics/vehicle_global_position.h>\n #include <uORB/topics/position_setpoint_triplet.h>\n@@ -128,10 +125,14 @@ class MissionBlock : public NavigatorMode\n \tbool _waypoint_yaw_reached;\n \thrt_abstime _time_first_inside_orbit;\n \thrt_abstime _action_start;\n+\thrt_abstime _time_wp_reached;\n \n \tactuator_controls_s _actuators;\n \torb_advert_t    _actuator_pub;\n \torb_advert_t\t_cmd_pub;\n+\n+\tcontrol::BlockParamFloat _param_yaw_timeout;\n+\tcontrol::BlockParamFloat _param_yaw_err;\n \tcontrol::BlockParamInt _param_vtol_wv_land;\n \tcontrol::BlockParamInt _param_vtol_wv_loiter;\n };"},{"sha":"fdc8cd46ff4493562597b14c0af04483f1b9d48f","filename":"src/modules/navigator/mission_params.c","status":"modified","additions":22,"deletions":0,"changes":22,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/bb4decfa8b6cbf03ee4408ec6554f72565277de7/src%2Fmodules%2Fnavigator%2Fmission_params.c","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/bb4decfa8b6cbf03ee4408ec6554f72565277de7/src%2Fmodules%2Fnavigator%2Fmission_params.c","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fnavigator%2Fmission_params.c?ref=bb4decfa8b6cbf03ee4408ec6554f72565277de7","patch":"@@ -107,3 +107,25 @@ PARAM_DEFINE_INT32(MIS_ALTMODE, 1);\n  * @group Mission\n  */\n PARAM_DEFINE_INT32(MIS_YAWMODE, 1);\n+\n+/**\n+ * Time in seconds we wait on reaching target heading at a waypoint.\n+ *\n+ * Prevents missions getting blocked at waypoints because it cannot reach target yaw.\n+ * Mainly useful for VTOLs that have less yaw authority and might not reach target\n+ * yaw in wind. Disabled by default. Can be set to 0 if it should not care for yaw on waypoints.\n+ *\n+ * @min -1\n+ * @max 20\n+ * @group Mission\n+ */\n+PARAM_DEFINE_FLOAT(MIS_YAW_TMT, -1.0f);\n+\n+/**\n+ * Max yaw error in degree needed for waypoint heading acceptance.\n+ *\n+ * @min 0\n+ * @max 90\n+ * @group Mission\n+ */\n+PARAM_DEFINE_FLOAT(MIS_YAW_ERR, 12.0f);"}]}