{"sha":"52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da","node_id":"MDY6Q29tbWl0NTI5ODc5MDo1MmZjNTZhNjFmMDliY2JhMzlkNDVhMzRjNWUwZTU1ZjBhNmZhOGRh","commit":{"author":{"name":"Beat KÃ¼ng","email":"beat-kueng@gmx.net","date":"2018-10-31T00:36:25Z"},"committer":{"name":"Daniel Agar","email":"daniel@agar.ca","date":"2018-10-31T00:36:25Z"},"message":"gps: explicitly set SPI bus speed to 1MHz\n\nRequired on RPi, the default seems to be too high.","tree":{"sha":"f9a7ebe0a21cf2350f97fae89de9a271ec931c1a","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/f9a7ebe0a21cf2350f97fae89de9a271ec931c1a"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da","html_url":"https://github.com/PX4/PX4-Autopilot/commit/52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da/comments","author":{"login":"bkueng","id":281593,"node_id":"MDQ6VXNlcjI4MTU5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/281593?v=4","gravatar_id":"","url":"https://api.github.com/users/bkueng","html_url":"https://github.com/bkueng","followers_url":"https://api.github.com/users/bkueng/followers","following_url":"https://api.github.com/users/bkueng/following{/other_user}","gists_url":"https://api.github.com/users/bkueng/gists{/gist_id}","starred_url":"https://api.github.com/users/bkueng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bkueng/subscriptions","organizations_url":"https://api.github.com/users/bkueng/orgs","repos_url":"https://api.github.com/users/bkueng/repos","events_url":"https://api.github.com/users/bkueng/events{/privacy}","received_events_url":"https://api.github.com/users/bkueng/received_events","type":"User","site_admin":false},"committer":{"login":"dagar","id":84712,"node_id":"MDQ6VXNlcjg0NzEy","avatar_url":"https://avatars.githubusercontent.com/u/84712?v=4","gravatar_id":"","url":"https://api.github.com/users/dagar","html_url":"https://github.com/dagar","followers_url":"https://api.github.com/users/dagar/followers","following_url":"https://api.github.com/users/dagar/following{/other_user}","gists_url":"https://api.github.com/users/dagar/gists{/gist_id}","starred_url":"https://api.github.com/users/dagar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dagar/subscriptions","organizations_url":"https://api.github.com/users/dagar/orgs","repos_url":"https://api.github.com/users/dagar/repos","events_url":"https://api.github.com/users/dagar/events{/privacy}","received_events_url":"https://api.github.com/users/dagar/received_events","type":"User","site_admin":false},"parents":[{"sha":"bec43b0b28e6817fb23e0ef323ed929ce65360ed","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/bec43b0b28e6817fb23e0ef323ed929ce65360ed","html_url":"https://github.com/PX4/PX4-Autopilot/commit/bec43b0b28e6817fb23e0ef323ed929ce65360ed"}],"stats":{"total":24,"additions":24,"deletions":0},"files":[{"sha":"4dae509bd314d9998123fc2dda7a64ea6366e506","filename":"src/drivers/gps/gps.cpp","status":"modified","additions":24,"deletions":0,"changes":24,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da/src%2Fdrivers%2Fgps%2Fgps.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da/src%2Fdrivers%2Fgps%2Fgps.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fdrivers%2Fgps%2Fgps.cpp?ref=52fc56a61f09bcba39d45a34c5e0e55f0a6fa8da","patch":"@@ -87,6 +87,9 @@\n #include \"devices/src/mtk.h\"\n #include \"devices/src/ashtech.h\"\n \n+#ifdef __PX4_LINUX\n+#include <linux/spi/spidev.h>\n+#endif /* __PX4_LINUX */\n \n #define TIMEOUT_5HZ 500\n #define RATE_MEASUREMENT_PERIOD 5000000\n@@ -608,6 +611,27 @@ GPS::run()\n \t\t\tPX4_ERR(\"GPS: failed to open serial port: %s err: %d\", _port, errno);\n \t\t\treturn;\n \t\t}\n+\n+#ifdef __PX4_LINUX\n+\n+\t\tif (_interface == GPSHelper::Interface::SPI) {\n+\t\t\tint spi_speed = 1000000; // make sure the bus speed is not too high (required on RPi)\n+\t\t\tint status_value = ioctl(_serial_fd, SPI_IOC_WR_MAX_SPEED_HZ, &spi_speed);\n+\n+\t\t\tif (status_value < 0) {\n+\t\t\t\tPX4_ERR(\"SPI_IOC_WR_MAX_SPEED_HZ failed for %s (%d)\", _port, errno);\n+\t\t\t\treturn;\n+\t\t\t}\n+\n+\t\t\tstatus_value = ioctl(_serial_fd, SPI_IOC_RD_MAX_SPEED_HZ, &spi_speed);\n+\n+\t\t\tif (status_value < 0) {\n+\t\t\t\tPX4_ERR(\"SPI_IOC_RD_MAX_SPEED_HZ failed for %s (%d)\", _port, errno);\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t}\n+\n+#endif /* __PX4_LINUX */\n \t}\n \n \tparam_t handle = param_find(\"GPS_YAW_OFFSET\");"}]}