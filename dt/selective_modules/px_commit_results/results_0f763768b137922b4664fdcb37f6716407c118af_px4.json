{"sha":"0f763768b137922b4664fdcb37f6716407c118af","node_id":"MDY6Q29tbWl0NTI5ODc5MDowZjc2Mzc2OGIxMzc5MjJiNDY2NGZkY2IzN2Y2NzE2NDA3YzExOGFm","commit":{"author":{"name":"Julian Oes","email":"julian@oes.ch","date":"2016-09-29T09:30:34Z"},"committer":{"name":"Lorenz Meier","email":"lorenz@px4.io","date":"2016-10-10T20:47:07Z"},"message":"commander: don't auto-disarm as fast if not flown\n\nIt was found inconvenient that auto-disarm triggers too quickly right\nafter arming when the vehicle has not actually taken off yet.\n\nTherefore, the auto-disarm takes now by a factor of 5 longer if the\nvehicle has not taken off yet.","tree":{"sha":"b9ebb4233d83b9928fdeb71e06b2870bfe3f2970","url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/trees/b9ebb4233d83b9928fdeb71e06b2870bfe3f2970"},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/git/commits/0f763768b137922b4664fdcb37f6716407c118af","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/0f763768b137922b4664fdcb37f6716407c118af","html_url":"https://github.com/PX4/PX4-Autopilot/commit/0f763768b137922b4664fdcb37f6716407c118af","comments_url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/0f763768b137922b4664fdcb37f6716407c118af/comments","author":{"login":"julianoes","id":1419688,"node_id":"MDQ6VXNlcjE0MTk2ODg=","avatar_url":"https://avatars.githubusercontent.com/u/1419688?v=4","gravatar_id":"","url":"https://api.github.com/users/julianoes","html_url":"https://github.com/julianoes","followers_url":"https://api.github.com/users/julianoes/followers","following_url":"https://api.github.com/users/julianoes/following{/other_user}","gists_url":"https://api.github.com/users/julianoes/gists{/gist_id}","starred_url":"https://api.github.com/users/julianoes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/julianoes/subscriptions","organizations_url":"https://api.github.com/users/julianoes/orgs","repos_url":"https://api.github.com/users/julianoes/repos","events_url":"https://api.github.com/users/julianoes/events{/privacy}","received_events_url":"https://api.github.com/users/julianoes/received_events","type":"User","site_admin":false},"committer":{"login":"LorenzMeier","id":1208119,"node_id":"MDQ6VXNlcjEyMDgxMTk=","avatar_url":"https://avatars.githubusercontent.com/u/1208119?v=4","gravatar_id":"","url":"https://api.github.com/users/LorenzMeier","html_url":"https://github.com/LorenzMeier","followers_url":"https://api.github.com/users/LorenzMeier/followers","following_url":"https://api.github.com/users/LorenzMeier/following{/other_user}","gists_url":"https://api.github.com/users/LorenzMeier/gists{/gist_id}","starred_url":"https://api.github.com/users/LorenzMeier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LorenzMeier/subscriptions","organizations_url":"https://api.github.com/users/LorenzMeier/orgs","repos_url":"https://api.github.com/users/LorenzMeier/repos","events_url":"https://api.github.com/users/LorenzMeier/events{/privacy}","received_events_url":"https://api.github.com/users/LorenzMeier/received_events","type":"User","site_admin":false},"parents":[{"sha":"ddea179e95729c3ac7cf5e3cd8419255736ac2ce","url":"https://api.github.com/repos/PX4/PX4-Autopilot/commits/ddea179e95729c3ac7cf5e3cd8419255736ac2ce","html_url":"https://github.com/PX4/PX4-Autopilot/commit/ddea179e95729c3ac7cf5e3cd8419255736ac2ce"}],"stats":{"total":25,"additions":23,"deletions":2},"files":[{"sha":"5611c0a94d20993299904e84d99aa56184e659a4","filename":"src/modules/commander/commander.cpp","status":"modified","additions":19,"deletions":2,"changes":21,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/0f763768b137922b4664fdcb37f6716407c118af/src%2Fmodules%2Fcommander%2Fcommander.cpp","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/0f763768b137922b4664fdcb37f6716407c118af/src%2Fmodules%2Fcommander%2Fcommander.cpp","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fcommander%2Fcommander.cpp?ref=0f763768b137922b4664fdcb37f6716407c118af","patch":"@@ -1612,6 +1612,8 @@ int commander_thread_main(int argc, char *argv[])\n \tbool main_state_changed = false;\n \tbool failsafe_old = false;\n \n+\tbool have_taken_off_since_arming = false;\n+\n \t/* initialize low priority thread */\n \tpthread_attr_t commander_low_prio_attr;\n \tpthread_attr_init(&commander_low_prio_attr);\n@@ -1686,8 +1688,6 @@ int commander_thread_main(int argc, char *argv[])\n \t\t\tparam_get(_param_ef_time_thres, &ef_time_thres);\n \t\t\tparam_get(_param_geofence_action, &geofence_action);\n \t\t\tparam_get(_param_disarm_land, &disarm_when_landed);\n-\t\t\tauto_disarm_hysteresis.set_hysteresis_time_from(false,\n-\t\t\t\t\t\t\t\t\t(hrt_abstime)disarm_when_landed * 1000000);\n \n \t\t\tparam_get(_param_low_bat_act, &low_bat_action);\n \t\t\tparam_get(_param_offboard_loss_timeout, &offboard_loss_timeout);\n@@ -2049,6 +2049,7 @@ int commander_thread_main(int argc, char *argv[])\n \t\t\t\t\tmavlink_and_console_log_info(&mavlink_log_pub, \"Landing detected\");\n \t\t\t\t} else {\n \t\t\t\t\tmavlink_and_console_log_info(&mavlink_log_pub, \"Takeoff detected\");\n+\t\t\t\t\thave_taken_off_since_arming = true;\n \t\t\t\t}\n \t\t\t}\n \n@@ -2063,6 +2064,17 @@ int commander_thread_main(int argc, char *argv[])\n \t\t\twas_falling = land_detector.freefall;\n \t\t}\n \n+\n+\n+\t\t/* Update hysteresis time. Use a time of factor 5 longer if we have not taken off yet. */\n+\t\thrt_abstime timeout_time = disarm_when_landed * 1000000;\n+\n+\t\tif (!have_taken_off_since_arming) {\n+\t\t\ttimeout_time *= 5;\n+\t\t}\n+\n+\t\tauto_disarm_hysteresis.set_hysteresis_time_from(false, timeout_time);\n+\n \t\t// Check for auto-disarm\n \t\tif (armed.armed && land_detector.landed && disarm_when_landed > 0) {\n \t\t\tauto_disarm_hysteresis.set_state_and_update(true);\n@@ -2914,6 +2926,11 @@ int commander_thread_main(int argc, char *argv[])\n \n \t\tstatus_changed = false;\n \n+\t\tif (!armed.armed) {\n+\t\t\t/* Reset the flag if disarmed. */\n+\t\t\thave_taken_off_since_arming = false;\n+\t\t}\n+\n \n \t\t/* publish internal state for logging purposes */\n \t\tif (commander_state_pub != nullptr) {"},{"sha":"a8f91cb91a6bf9f874efee835c488f5b055b8a7f","filename":"src/modules/commander/commander_params.c","status":"modified","additions":4,"deletions":0,"changes":4,"blob_url":"https://github.com/PX4/PX4-Autopilot/blob/0f763768b137922b4664fdcb37f6716407c118af/src%2Fmodules%2Fcommander%2Fcommander_params.c","raw_url":"https://github.com/PX4/PX4-Autopilot/raw/0f763768b137922b4664fdcb37f6716407c118af/src%2Fmodules%2Fcommander%2Fcommander_params.c","contents_url":"https://api.github.com/repos/PX4/PX4-Autopilot/contents/src%2Fmodules%2Fcommander%2Fcommander_params.c?ref=0f763768b137922b4664fdcb37f6716407c118af","patch":"@@ -251,6 +251,10 @@ PARAM_DEFINE_INT32(COM_RC_ARM_HYST, 1000);\n  *\n  * A non-zero, positive value specifies the time-out period in seconds after which the vehicle will be\n  * automatically disarmed in case a landing situation has been detected during this period.\n+ *\n+ * The vehicle will also auto-disarm right after arming if it has not even flown, however the time\n+ * will be longer by a factor of 5.\n+ *\n  * A value of zero means that automatic disarming is disabled.\n  *\n  * @group Commander"}]}